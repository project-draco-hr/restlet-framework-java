{
  Series<Parameter> headers=new Form();
  Request request=response.getRequest();
  try {
    try {
      addTransportHeaders(headers,request.getEntity());
      addRequestHeaders(request,headers);
      Series<Parameter> additionalHeaders=(Series<Parameter>)request.getAttributes().get(HeaderConstants.ATTRIBUTE_HEADERS);
      addAdditionalHeaders(headers,additionalHeaders);
    }
 catch (    Exception e) {
      getLogger().log(Level.INFO,"Exception intercepted while adding the response headers",e);
      response.setStatus(Status.SERVER_ERROR_INTERNAL);
    }
    writeMessage(response,headers);
  }
 catch (  Exception e) {
    getLogger().log(Level.INFO,"An exception occured writing the request entity",e);
    response.setStatus(Status.CONNECTOR_ERROR_COMMUNICATION,"An exception occured writing the request entity");
    response.setEntity(null);
    try {
      writeMessage(response,headers);
    }
 catch (    IOException ioe) {
      getLogger().log(Level.WARNING,"Unable to send error response",ioe);
    }
  }
 finally {
    if (request.getOnSent() != null) {
      request.getOnSent().handle(request,response);
    }
    if (!request.isExpectingResponse()) {
      getOutboundMessages().remove(response);
    }
  }
}

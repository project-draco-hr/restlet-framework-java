def testIteration(self):
    dataoffset = 16384
    filler = 'ham\n'
    assert (not (dataoffset % len(filler))), 'dataoffset must be multiple of len(filler)'
    nchunks = (dataoffset // len(filler))
    testlines = ['spam, spam and eggs\n', 'eggs, spam, ham and spam\n', 'saussages, spam, spam and eggs\n', 'spam, ham, spam and eggs\n', 'spam, spam, spam, spam, spam, ham, spam\n', 'wonderful spaaaaaam.\n']
    methods = [('readline', ()), ('read', ()), ('readlines', ()), ('readinto', (array('c', (' ' * 100)),))]
    try:
        bag = open(TESTFN, 'w')
        bag.write((filler * nchunks))
        bag.writelines(testlines)
        bag.close()
        for (methodname, args) in methods:
            f = open(TESTFN)
            if (f.next() != filler):
                (self.fail, 'Broken testfile')
            meth = getattr(f, methodname)
            try:
                meth(*args)
            except ValueError:
                pass
            else:
                self.fail(("%s%r after next() didn't raise ValueError" % (methodname, args)))
            f.close()
        f = open(TESTFN)
        for i in range(nchunks):
            f.next()
        testline = testlines.pop(0)
        try:
            line = f.readline()
        except ValueError:
            self.fail('readline() after next() with supposedly empty iteration-buffer failed anyway')
        if (line != testline):
            self.fail(('readline() after next() with empty buffer failed. Got %r, expected %r' % (line, testline)))
        testline = testlines.pop(0)
        buf = array('c', ('\x00' * len(testline)))
        try:
            f.readinto(buf)
        except ValueError:
            self.fail('readinto() after next() with supposedly empty iteration-buffer failed anyway')
        line = buf.tostring()
        if (line != testline):
            self.fail(('readinto() after next() with empty buffer failed. Got %r, expected %r' % (line, testline)))
        testline = testlines.pop(0)
        try:
            line = f.read(len(testline))
        except ValueError:
            self.fail('read() after next() with supposedly empty iteration-buffer failed anyway')
        if (line != testline):
            self.fail(('read() after next() with empty buffer failed. Got %r, expected %r' % (line, testline)))
        try:
            lines = f.readlines()
        except ValueError:
            self.fail('readlines() after next() with supposedly empty iteration-buffer failed anyway')
        if (lines != testlines):
            self.fail(('readlines() after next() with empty buffer failed. Got %r, expected %r' % (line, testline)))
        f = open(TESTFN)
        try:
            for line in f:
                pass
            try:
                f.readline()
                f.readinto(buf)
                f.read()
                f.readlines()
            except ValueError:
                self.fail('read* failed after next() consumed file')
        finally:
            f.close()
    finally:
        os.unlink(TESTFN)

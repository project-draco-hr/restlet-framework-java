{
  ClientCall clientCall=null;
  try {
    clientCall=createCall(call.getMethod().getName(),call.getResourceRef().toString(),hasInput(call));
    if (call.getClientName() != null) {
      clientCall.addRequestHeader(ConnectorCall.HEADER_USER_AGENT,call.getClientName());
    }
 else {
      clientCall.addRequestHeader(ConnectorCall.HEADER_USER_AGENT,FactoryImpl.VERSION_HEADER);
    }
    ConditionData condition=call.getCondition();
    if (condition.getMatch() != null) {
      StringBuilder value=new StringBuilder();
      for (int i=0; i < condition.getMatch().size(); i++) {
        if (i > 0)         value.append(", ");
        value.append(condition.getMatch().get(i).getName());
      }
      clientCall.addRequestHeader(ConnectorCall.HEADER_IF_MATCH,value.toString());
    }
    if (condition.getModifiedSince() != null) {
      String imsDate=DateUtils.format(condition.getModifiedSince(),DateUtils.FORMAT_RFC_1123[0]);
      clientCall.addRequestHeader(ConnectorCall.HEADER_IF_MODIFIED_SINCE,imsDate);
    }
    if (condition.getNoneMatch() != null) {
      StringBuilder value=new StringBuilder();
      for (int i=0; i < condition.getNoneMatch().size(); i++) {
        if (i > 0)         value.append(", ");
        value.append(condition.getNoneMatch().get(i).getName());
      }
      clientCall.addRequestHeader(ConnectorCall.HEADER_IF_NONE_MATCH,value.toString());
    }
    if (condition.getUnmodifiedSince() != null) {
      String iusDate=DateUtils.format(condition.getUnmodifiedSince(),DateUtils.FORMAT_RFC_1123[0]);
      clientCall.addRequestHeader(ConnectorCall.HEADER_IF_UNMODIFIED_SINCE,iusDate);
    }
    if (call.getCookies().size() > 0) {
      String cookies=CookieUtils.format(call.getCookies());
      clientCall.addRequestHeader(ConnectorCall.HEADER_COOKIE,cookies);
    }
    if (call.getReferrerRef() != null) {
      clientCall.addRequestHeader(ConnectorCall.HEADER_REFERRER,call.getReferrerRef().toString());
    }
    PreferenceData pref=call.getPreference();
    if (pref.getMediaTypes().size() > 0) {
      clientCall.addRequestHeader(ConnectorCall.HEADER_ACCEPT,PreferenceUtils.format(pref.getMediaTypes()));
    }
 else {
      clientCall.addRequestHeader(ConnectorCall.HEADER_ACCEPT,MediaTypes.ALL.getName());
    }
    if (pref.getCharacterSets().size() > 0) {
      clientCall.addRequestHeader(ConnectorCall.HEADER_ACCEPT_CHARSET,PreferenceUtils.format(pref.getCharacterSets()));
    }
    if (pref.getEncodings().size() > 0) {
      clientCall.addRequestHeader(ConnectorCall.HEADER_ACCEPT_ENCODING,PreferenceUtils.format(pref.getEncodings()));
    }
    if (pref.getLanguages().size() > 0) {
      clientCall.addRequestHeader(ConnectorCall.HEADER_ACCEPT_LANGUAGE,PreferenceUtils.format(pref.getLanguages()));
    }
    ChallengeResponse response=call.getSecurity().getChallengeResponse();
    if (response != null) {
      clientCall.addRequestHeader(ConnectorCall.HEADER_AUTHORIZATION,SecurityUtils.format(response));
    }
    for (    Parameter header : call.getConnectorCall().getRequestHeaders()) {
      clientCall.addRequestHeader(header.getName(),header.getValue());
    }
    if (hasInput(call)) {
      if (call.getInput().getSize() > 0) {
        clientCall.addRequestHeader(ConnectorCall.HEADER_CONTENT_LENGTH,Long.toString(call.getInput().getSize()));
      }
      if (call.getInput().getMetadata().getMediaType() != null) {
        clientCall.addRequestHeader(ConnectorCall.HEADER_CONTENT_TYPE,call.getInput().getMetadata().getMediaType().toString());
      }
      if (call.getInput().getMetadata().getEncoding() != null) {
        clientCall.addRequestHeader(ConnectorCall.HEADER_CONTENT_ENCODING,call.getInput().getMetadata().getEncoding().toString());
      }
      if (call.getInput().getMetadata().getLanguage() != null) {
        clientCall.addRequestHeader(ConnectorCall.HEADER_CONTENT_LANGUAGE,call.getInput().getMetadata().getLanguage().toString());
      }
    }
  }
 catch (  Exception e) {
    logger.log(Level.FINE,"An unexpected error occured during the preparation of the HTTP client call.",e);
    call.setStatus(new DefaultStatus(Statuses.CONNECTOR_ERROR_INTERNAL,"Unable to create the HTTP call and its headers. " + e.getMessage()));
  }
  try {
    clientCall.sendRequestHeaders();
    if (hasInput(call)) {
      clientCall.sendRequestInput(call.getInput());
    }
    call.setStatus(new DefaultStatus(clientCall.getResponseStatusCode(),null,clientCall.getResponseReasonPhrase(),null));
  }
 catch (  ConnectException ce) {
    logger.log(Level.FINE,"An error occured during the connection to the remote HTTP server.",ce);
    call.setStatus(new DefaultStatus(Statuses.CONNECTOR_ERROR_CONNECTION,"Unable to connect to the remote server. " + ce.getMessage()));
  }
catch (  SocketTimeoutException ste) {
    logger.log(Level.FINE,"An timeout error occured during the communication with the remote HTTP server.",ste);
    call.setStatus(new DefaultStatus(Statuses.CONNECTOR_ERROR_COMMUNICATION,"Unable to complete the HTTP call due to a communication timeout error. " + ste.getMessage()));
  }
catch (  FileNotFoundException fnfe) {
    logger.log(Level.FINE,"An unexpected error occured during the sending of the HTTP request.",fnfe);
    call.setStatus(new DefaultStatus(Statuses.CONNECTOR_ERROR_INTERNAL,"Unable to find a local file for sending. " + fnfe.getMessage()));
  }
catch (  IOException ioe) {
    logger.log(Level.FINE,"An error occured during the communication with the remote HTTP server.",ioe);
    call.setStatus(new DefaultStatus(Statuses.CONNECTOR_ERROR_COMMUNICATION,"Unable to complete the HTTP call due to a communication error with the remote server. " + ioe.getMessage()));
  }
catch (  Exception e) {
    logger.log(Level.FINE,"An unexpected error occured during the sending of the HTTP request.",e);
    call.setStatus(new DefaultStatus(Statuses.CONNECTOR_ERROR_INTERNAL,"Unable to send the HTTP request. " + e.getMessage()));
  }
  try {
    call.setServerAddress(clientCall.getResponseAddress());
    call.setConnectorCall(clientCall);
    ContentType contentType=null;
    int size=-1;
    Date expires=null;
    Date lastModified=null;
    Encoding encoding=null;
    Language language=null;
    Tag tag=null;
    for (    Parameter header : clientCall.getResponseHeaders()) {
      if (header.getName().equalsIgnoreCase(ConnectorCall.HEADER_CONTENT_TYPE)) {
        contentType=new ContentType(header.getValue());
      }
 else       if (header.getName().equalsIgnoreCase(ConnectorCall.HEADER_CONTENT_LENGTH)) {
        size=Integer.parseInt(header.getValue());
      }
 else       if (header.getName().equalsIgnoreCase(ConnectorCall.HEADER_EXPIRES)) {
        expires=clientCall.parseDate(header.getValue(),false);
      }
 else       if (header.getName().equalsIgnoreCase(ConnectorCall.HEADER_CONTENT_ENCODING)) {
        encoding=new DefaultEncoding(header.getValue());
      }
 else       if (header.getName().equalsIgnoreCase(ConnectorCall.HEADER_CONTENT_LANGUAGE)) {
        language=new DefaultLanguage(header.getValue());
      }
 else       if (header.getName().equalsIgnoreCase(ConnectorCall.HEADER_LAST_MODIFIED)) {
        lastModified=clientCall.parseDate(header.getValue(),false);
      }
 else       if (header.getName().equalsIgnoreCase(ConnectorCall.HEADER_ETAG)) {
        tag=new Tag(header.getValue());
      }
 else       if (header.getName().equalsIgnoreCase(ConnectorCall.HEADER_LOCATION)) {
        call.setRedirectionRef(header.getValue());
      }
 else       if ((header.getName().equalsIgnoreCase(ConnectorCall.HEADER_SET_COOKIE)) || (header.getName().equalsIgnoreCase(ConnectorCall.HEADER_SET_COOKIE2))) {
        try {
          CookieReader cr=new CookieReader(header.getValue());
          call.getCookieSettings().add(cr.readCookieSetting());
        }
 catch (        Exception e) {
          logger.log(Level.WARNING,"Error during cookie setting parsing. Header: " + header.getValue(),e);
        }
      }
 else       if (header.getName().equalsIgnoreCase(ConnectorCall.HEADER_WWW_AUTHENTICATE)) {
        ChallengeRequest request=SecurityUtils.parseRequest(header.getValue());
        call.getSecurity().setChallengeRequest(request);
      }
 else       if (header.getName().equalsIgnoreCase(ConnectorCall.HEADER_SERVER)) {
        call.setServerName(header.getValue());
      }
    }
    Representation output=null;
    if (clientCall.getResponseStream() != null) {
      MediaType mediaType=null;
      if (contentType != null)       mediaType=contentType.getMediaType();
      output=new InputRepresentation(clientCall.getResponseStream(),mediaType);
    }
 else     if (clientCall.getResponseChannel() != null) {
      output=new ReadableRepresentation(clientCall.getResponseChannel(),contentType.getMediaType());
    }
    if (output != null) {
      if (contentType != null)       output.getMetadata().setCharacterSet(contentType.getCharacterSet());
      output.setSize(size);
      output.getMetadata().setEncoding(encoding);
      output.getMetadata().setExpirationDate(expires);
      output.getMetadata().setLanguage(language);
      output.getMetadata().setModificationDate(lastModified);
      output.getMetadata().setTag(tag);
      call.setOutput(output);
    }
  }
 catch (  Exception e) {
    logger.log(Level.FINE,"An error occured during the processing of the HTTP response.",e);
    call.setStatus(new DefaultStatus(Statuses.CONNECTOR_ERROR_INTERNAL,"Unable to process the response. " + e.getMessage()));
  }
}

{
  Form params=getQuery();
  String redirUri=params.getFirstValue(REDIR_URI);
  String sessionId=null;
  if (session != null)   sessionId=session.getId();
  if (redirUri == null || redirUri.length() == 0) {
    sendError(sessionId,OAuthError.INVALID_REQUEST,params.getFirstValue(STATE),"No redirect_uri parameter found.",null);
    getLogger().info("No mandatory redirect URI provided");
    return;
  }
  Client client=clients.findById(clientId);
  getLogger().info("Client = " + client);
  if (client == null) {
    sendError(sessionId,OAuthError.INVALID_CLIENT,params.getFirstValue(STATE),"Need to register the client : " + clientId,null);
    getLogger().info("Need to register the client : " + clientId);
    return;
  }
  getLogger().info("Compare client redir:provided redir = " + client.getRedirectUri() + ":"+ redirUri);
  if (!redirUri.startsWith(client.getRedirectUri())) {
    sendError(sessionId,OAuthError.REDIRECT_URI_MISMATCH,params.getFirstValue(STATE),"Callback URI does not match.",null);
    getLogger().info("Callback URI does not match.");
    return;
  }
  if (session != null && session.getScopeOwner() != null) {
    if (flow.equals(ResponseType.token) || flow.equals(ResponseType.code)) {
      String[] requestedScopes=parseScope(params.getFirstValue(SCOPE));
      for (      String scope : requestedScopes) {
        getLogger().info("Requested scopes = " + scope);
      }
      session.setClient(client);
      session.setAuthFlow(flow);
      session.setRequestedScope(requestedScopes);
      if (!redirUri.equals(client.getRedirectUri())) {
        session.setDynamicCallbackURI(redirUri);
        getLogger().info("OAuth2 set dynamic callback = " + redirUri);
      }
      String state=getCookies().getFirstValue(STATE);
      if (state != null && state.length() > 0)       session.setState(state);
      getResponse().setEntity(doPostAuthenticate(session,client));
      return;
    }
  }
 else {
    getLogger().info("Base ref = " + getReference().getParentRef());
    Reference ref=new Reference("riap://application/login");
    getLogger().info("OAuth2 session = " + session);
    if (session == null) {
      session=new AuthSession(getContext().getAttributes(),new ScheduledThreadPoolExecutor(5));
      CookieSetting cs=new CookieSetting(ClientCookieID,session.getId());
      getCookieSettings().add(cs);
      getLogger().info("Setting cookie - " + session.getId());
    }
    session.setClient(client);
    session.setAuthFlow(flow);
    if (!redirUri.equals(client.getRedirectUri())) {
      session.setDynamicCallbackURI(redirUri);
      getLogger().info("OAuth2 set dynamic callback = " + redirUri);
    }
    String state=getCookies().getFirstValue(STATE);
    if (state != null && state.length() > 0)     session.setState(state);
    String[] scopes=parseScope(params.getFirstValue(SCOPE));
    session.setRequestedScope(scopes);
    getLogger().info("Setting callback url after Authentication = " + getReference().getBaseRef());
    Reference cb=new Reference(getReference().getBaseRef());
    cb.addQueryParameter("internal",null);
    ref.addQueryParameter("callback",cb.toString(true,false));
    getResponse().setCacheDirectives(noStore);
    Redirector dispatcher=new Redirector(getContext(),ref.toString(),Redirector.MODE_SERVER_OUTBOUND);
    dispatcher.handle(getRequest(),getResponse());
  }
}

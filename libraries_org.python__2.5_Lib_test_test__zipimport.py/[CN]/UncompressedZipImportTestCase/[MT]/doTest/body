def doTest(self, expected_ext, files, *modules, **kw):
    z = ZipFile(TEMP_ZIP, 'w')
    try:
        for (name, (mtime, data)) in files.items():
            zinfo = ZipInfo(name, time.localtime(mtime))
            zinfo.compress_type = self.compression
            z.writestr(zinfo, data)
        z.close()
        stuff = kw.get('stuff', None)
        if (stuff is not None):
            f = open(TEMP_ZIP, 'rb')
            data = f.read()
            f.close()
            f = open(TEMP_ZIP, 'wb')
            f.write(stuff)
            f.write(data)
            f.close()
        sys.path.insert(0, TEMP_ZIP)
        mod = __import__('.'.join(modules), globals(), locals(), ['__dummy__'])
        call = kw.get('call')
        if (call is not None):
            call(mod)
        if expected_ext:
            file = mod.get_file()
            self.assertEquals(file, (os.path.join(TEMP_ZIP, *modules) + expected_ext))
    finally:
        z.close()
        os.remove(TEMP_ZIP)

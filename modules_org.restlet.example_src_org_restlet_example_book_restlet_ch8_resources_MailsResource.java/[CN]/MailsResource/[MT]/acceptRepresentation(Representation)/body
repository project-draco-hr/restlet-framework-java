{
  Form form=new Form(entity);
  Mail mail=new Mail();
  mail.setStatus(Mail.STATUS_DRAFT);
  Contact sender=new Contact();
  sender.setName(getCurrentUser().getFirstName() + " " + getCurrentUser().getLastName());
  sender.setMailAddress(getRequest().getRootRef().getIdentifier() + "/mailboxes/" + mailbox.getId());
  mail.setSender(sender);
  mail.setSubject(form.getFirstValue("subject"));
  mail.setMessage(form.getFirstValue("message"));
  if (form.getFirstValue("recipients") != null) {
    List<Contact> recipients=new ArrayList<Contact>();
    for (    Parameter parameter : form.subList("recipients")) {
      for (      Contact contact : mailbox.getContacts()) {
        if (contact.getId().equals(parameter.getValue())) {
          recipients.add(contact);
        }
      }
    }
    mail.setRecipients(recipients);
  }
 else {
    mail.setRecipients(null);
  }
  if (form.getFirstValue("tags") != null) {
    mail.setTags(new ArrayList<String>(Arrays.asList(form.getFirstValue("tags").split(" "))));
  }
 else {
    mail.setTags(null);
  }
  mail=getDataFacade().createMail(mailbox,mail);
  getResponse().redirectSeeOther(getChildReference(getRequest().getResourceRef(),mail.getId()));
}

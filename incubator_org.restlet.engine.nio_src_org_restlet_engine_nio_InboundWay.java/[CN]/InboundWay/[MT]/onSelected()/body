{
  super.onSelected();
  if (getIoState() == IoState.READ_INTEREST) {
    setIoState(IoState.READING);
  }
 else   if (getIoState() == IoState.CANCELING) {
    setIoState(IoState.CANCELLED);
  }
  try {
    if (!getByteBuffer().hasRemaining()) {
      getByteBuffer().clear();
    }
    while ((getIoState() == IoState.READING) && (getMessageState() != MessageState.BODY)) {
      if (isFilling()) {
        int result=readSocketBytes();
        if (result == 0) {
          setIoState(IoState.READ_INTEREST);
        }
 else         if (result == -1) {
          setIoState(IoState.CANCELING);
        }
 else {
          ConnectedRequest request=(ConnectedRequest)((getMessage() == null) ? null : getMessage().getRequest());
          Series<Parameter> headers=(request == null) ? null : request.getHeaders();
          while (fillLine()) {
            if (getMessageState() == MessageState.START_LINE) {
              readStartLine();
            }
 else             if (getMessageState() == MessageState.HEADERS) {
              request=(ConnectedRequest)getMessage().getRequest();
              headers=(headers == null) ? request.getHeaders() : headers;
              Parameter header=readHeader();
              if (header != null) {
                if (headers == null) {
                  headers=new Form();
                }
                headers.add(header);
              }
 else {
                if (headers != null) {
                  request.setHeaders(headers);
                }
                if (HeaderUtils.isConnectionClose(headers)) {
                  getConnection().setState(ConnectionState.CLOSING);
                }
                Representation entity=createEntity(headers);
                request.setEntity(entity);
                if (request != null) {
                  if (request.isExpectingResponse()) {
                    getMessages().add(getMessage());
                  }
                  getHelper().getInboundMessages().add(getMessage());
                }
              }
            }
          }
        }
      }
    }
  }
 catch (  Exception e) {
    getLogger().log(Level.INFO,"Error while reading a message. Closing the connection.",e);
    getConnection().onError();
  }
}

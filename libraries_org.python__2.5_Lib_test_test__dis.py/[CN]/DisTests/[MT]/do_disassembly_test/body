def do_disassembly_test(self, func, expected):
    s = StringIO.StringIO()
    save_stdout = sys.stdout
    sys.stdout = s
    dis.dis(func)
    sys.stdout = save_stdout
    got = s.getvalue()
    lines = got.split('\n')
    lines = [line.rstrip() for line in lines]
    expected = expected.split('\n')
    import difflib
    if (expected != lines):
        self.fail(('events did not match expectation:\n' + '\n'.join(difflib.ndiff(expected, lines))))

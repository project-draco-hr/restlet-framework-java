from test_support import TESTFN, vereq, is_jython
import atexit
from os import popen, unlink
import sys
executable = sys.executable
if is_jython:
    executable = 'jython'
input = 'import atexit\n\ndef handler1():\n    print "handler1"\n\ndef handler2(*args, **kargs):\n    print "handler2", args, kargs\n\natexit.register(handler1)\natexit.register(handler2)\natexit.register(handler2, 7, kw="abc")\n'
fname = (TESTFN + '.py')
f = file(fname, 'w')
f.write(input)
f.close()
p = popen(('%s %s' % (executable, fname)))
output = p.read()
p.close()
vereq(output, "handler2 (7,) {'kw': 'abc'}\nhandler2 () {}\nhandler1\n")
input = 'def direct():\n    print "direct exit"\n\nimport sys\nsys.exitfunc = direct\n\n# Make sure atexit doesn\'t drop\ndef indirect():\n    print "indirect exit"\n\nimport atexit\natexit.register(indirect)\n'
f = file(fname, 'w')
f.write(input)
f.close()
p = popen(('%s %s' % (executable, fname)))
output = p.read()
p.close()
vereq(output, 'indirect exit\ndirect exit\n')
unlink(fname)

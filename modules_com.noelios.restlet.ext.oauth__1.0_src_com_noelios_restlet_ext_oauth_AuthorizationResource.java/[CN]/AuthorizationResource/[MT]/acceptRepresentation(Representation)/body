{
  final OAuthMessage requestMessage=OAuthHelper.getMessage(getRequest());
  final OAuthAccessor accessor=this.provider.getAccessor(requestMessage);
  if (accessor == null) {
    final ChallengeRequest challengeRequest=new ChallengeRequest(ChallengeScheme.HTTP_OAUTH,this.realm);
    getResponse().setChallengeRequest(challengeRequest);
    getResponse().setStatus(Status.CLIENT_ERROR_UNAUTHORIZED,"Invalid / expired Token");
    challengeRequest.getParameters().add("oauth_problem","token_rejected");
    return;
  }
  if (!isAuthorized()) {
    handleFailedAuthorization();
    return;
  }
  final String userId="user";
  this.provider.markAsAuthorized(accessor,userId);
  final String callback=getRequest().getResourceRef().getQueryAsForm().getFirstValue("oauth_callback");
  if (callback != null) {
    getResponse().setLocationRef(callback);
    getResponse().setStatus(Status.REDIRECTION_FOUND);
  }
 else {
    getResponse().setEntity("You have allowed authorization. Please close this browser window and click continue" + " in the client.",MediaType.TEXT_PLAIN);
  }
}

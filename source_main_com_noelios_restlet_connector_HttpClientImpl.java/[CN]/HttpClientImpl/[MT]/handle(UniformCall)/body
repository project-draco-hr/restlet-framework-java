{
  try {
    HttpClientCall clientCall=createCall(call.getMethod().getName(),call.getResourceRef().toString());
    if (call.getClientName() != null) {
      clientCall.addRequestHeader(HttpCall.HEADER_USER_AGENT,call.getClientName());
    }
 else {
      clientCall.addRequestHeader(HttpCall.HEADER_USER_AGENT,Engine.VERSION_HEADER);
    }
    ConditionData condition=call.getCondition();
    if (condition.getMatch() != null) {
      StringBuilder value=new StringBuilder();
      for (int i=0; i < condition.getMatch().size(); i++) {
        if (i > 0)         value.append(", ");
        value.append(condition.getMatch().get(i).getName());
      }
      clientCall.addRequestHeader(HttpCall.HEADER_IF_MATCH,value.toString());
    }
    if (condition.getModifiedSince() != null) {
      String imsDate=DateUtils.format(condition.getModifiedSince(),DateUtils.FORMAT_RFC_1123);
      clientCall.addRequestHeader(HttpCall.HEADER_IF_MODIFIED_SINCE,imsDate);
    }
    if (condition.getNoneMatch() != null) {
      StringBuilder value=new StringBuilder();
      for (int i=0; i < condition.getNoneMatch().size(); i++) {
        if (i > 0)         value.append(", ");
        value.append(condition.getNoneMatch().get(i).getName());
      }
      clientCall.addRequestHeader(HttpCall.HEADER_IF_NONE_MATCH,value.toString());
    }
    if (condition.getUnmodifiedSince() != null) {
      String iusDate=DateUtils.format(condition.getUnmodifiedSince(),DateUtils.FORMAT_RFC_1123);
      clientCall.addRequestHeader(HttpCall.HEADER_IF_UNMODIFIED_SINCE,iusDate);
    }
    if (call.getCookies().size() > 0) {
      String cookies=CookieUtils.format(call.getCookies());
      clientCall.addRequestHeader(HttpCall.HEADER_COOKIE,cookies);
    }
    if (call.getReferrerRef() != null) {
      clientCall.addRequestHeader(HttpCall.HEADER_REFERRER,call.getReferrerRef().toString());
    }
    PreferenceData pref=call.getPreference();
    if (pref.getMediaTypes() != null) {
      clientCall.addRequestHeader(HttpCall.HEADER_ACCEPT,PreferenceUtils.format(pref.getMediaTypes()));
    }
    if (pref.getCharacterSets() != null) {
      clientCall.addRequestHeader(HttpCall.HEADER_ACCEPT_CHARSET,PreferenceUtils.format(pref.getCharacterSets()));
    }
    if (pref.getEncodings() != null) {
      clientCall.addRequestHeader(HttpCall.HEADER_ACCEPT_ENCODING,PreferenceUtils.format(pref.getEncodings()));
    }
    if (pref.getLanguages() != null) {
      clientCall.addRequestHeader(HttpCall.HEADER_ACCEPT_LANGUAGE,PreferenceUtils.format(pref.getLanguages()));
    }
    ChallengeResponse response=call.getSecurity().getChallengeResponse();
    if (response != null) {
      clientCall.addRequestHeader(HttpCall.HEADER_AUTHORIZATION,SecurityUtils.format(response));
    }
    clientCall.commitRequestHeaders();
    if (call.getInput() != null) {
      if (clientCall.getRequestStream() != null) {
        call.getInput().write(clientCall.getRequestStream());
      }
 else       if (clientCall.getRequestChannel() != null) {
        call.getInput().write(clientCall.getRequestChannel());
      }
    }
    call.setStatus(new StatusImpl(clientCall.getResponseStatusCode()));
    call.setServerAddress(clientCall.getResponseAddress());
    ContentType contentType=null;
    Date expires=null;
    Date lastModified=null;
    Encoding encoding=null;
    Language language=null;
    Tag tag=null;
    Parameter header;
    for (Iterator<Parameter> iter=clientCall.getResponseHeaders().iterator(); iter.hasNext(); ) {
      header=iter.next();
      if (header.getName().equalsIgnoreCase(HttpCall.HEADER_CONTENT_TYPE)) {
        contentType=new ContentType(header.getValue());
      }
 else       if (header.getName().equalsIgnoreCase(HttpCall.HEADER_EXPIRES)) {
        expires=clientCall.parseDate(header.getValue(),false);
      }
 else       if (header.getName().equalsIgnoreCase(HttpCall.HEADER_CONTENT_ENCODING)) {
        encoding=Manager.createEncoding(header.getValue());
      }
 else       if (header.getName().equalsIgnoreCase(HttpCall.HEADER_CONTENT_LANGUAGE)) {
        language=Manager.createLanguage(header.getValue());
      }
 else       if (header.getName().equalsIgnoreCase(HttpCall.HEADER_LAST_MODIFIED)) {
        lastModified=clientCall.parseDate(header.getValue(),false);
      }
 else       if (header.getName().equalsIgnoreCase(HttpCall.HEADER_ETAG)) {
        tag=Manager.createTag(header.getValue());
      }
 else       if (header.getName().equalsIgnoreCase(HttpCall.HEADER_LOCATION)) {
        call.setRedirectRef(Manager.createReference(header.getValue()));
      }
 else       if ((header.getName().equalsIgnoreCase(HttpCall.HEADER_SET_COOKIE)) || (header.getName().equalsIgnoreCase(HttpCall.HEADER_SET_COOKIE2))) {
        try {
          CookieReader cr=new CookieReader(header.getValue());
          call.getCookieSettings().add(cr.readCookieSetting());
        }
 catch (        Exception e) {
          logger.log(Level.WARNING,"Error during cookie setting parsing. Header: " + header.getValue(),e);
        }
      }
 else       if (header.getName().equalsIgnoreCase(HttpCall.HEADER_WWW_AUTHENTICATE)) {
        ChallengeRequest request=SecurityUtils.parseRequest(header.getValue());
        call.getSecurity().setChallengeRequest(request);
      }
 else       if (header.getName().equalsIgnoreCase(HttpCall.HEADER_SERVER)) {
        call.setServerName(header.getValue());
      }
    }
    if (contentType != null) {
      Representation output=null;
      if (clientCall.getResponseStream() != null) {
        output=new InputRepresentation(clientCall.getResponseStream(),contentType.getMediaType());
      }
 else       if (clientCall.getResponseChannel() != null) {
        output=new ReadableRepresentation(clientCall.getResponseChannel(),contentType.getMediaType());
      }
      if (output != null) {
        if (contentType != null)         output.getMetadata().setCharacterSet(contentType.getCharacterSet());
        output.getMetadata().setEncoding(encoding);
        output.getMetadata().setExpirationDate(expires);
        output.getMetadata().setLanguage(language);
        output.getMetadata().setModificationDate(lastModified);
        output.getMetadata().setTag(tag);
        call.setOutput(output);
      }
    }
  }
 catch (  Exception e) {
    logger.log(Level.WARNING,"An error occured during the handling of an HTTP client call.",e);
  }
}

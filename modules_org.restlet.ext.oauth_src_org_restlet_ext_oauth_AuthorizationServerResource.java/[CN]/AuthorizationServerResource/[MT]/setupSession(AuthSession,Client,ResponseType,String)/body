{
  getLogger().fine("Base ref = " + getReference().getParentRef());
  getLogger().fine("OAuth2 session = " + in);
  AuthSession session=in;
  if (session == null) {
    session=new AuthSession(getContext().getAttributes(),new ScheduledThreadPoolExecutor(5));
    CookieSetting cs=new CookieSetting(ClientCookieID,session.getId());
    getCookieSettings().add(cs);
    getLogger().fine("Setting cookie in SetupSession - " + session.getId());
  }
  session.setClient(client);
  session.setAuthFlow(flow);
  if (!redirUri.equals(client.getRedirectUri())) {
    session.setDynamicCallbackURI(redirUri);
    getLogger().fine("OAuth2 set dynamic callback = " + redirUri);
  }
  String state=getCookies().getFirstValue(STATE);
  if (state != null && !state.isEmpty()) {
    session.setState(state);
  }
  return session;
}

{
  if (variants == null) {
    return null;
  }
 else {
    Parameter currentParam=null;
    boolean compatiblePref=false;
    boolean compatibleLanguage=false;
    RepresentationMetadata currentVariant=null;
    Language currentLanguage=null;
    MediaType currentMediaType=null;
    RepresentationMetadata bestVariant=null;
    float bestQuality=0;
    LanguagePref currentLanguagePref=null;
    LanguagePref bestLanguagePref=null;
    MediaTypePref currentMediaTypePref=null;
    MediaTypePref bestMediaTypePref=null;
    float currentScore=0;
    float bestLanguageScore=0;
    float bestMediaTypeScore=0;
    for (Iterator iter1=variants.iterator(); iter1.hasNext(); ) {
      currentVariant=(RepresentationMetadata)iter1.next();
      if (getPreference().getLanguages() != null) {
        for (Iterator<LanguagePref> iter2=getPreference().getLanguages().iterator(); (currentVariant.getLanguage() != null) && iter2.hasNext(); ) {
          currentLanguagePref=iter2.next();
          currentLanguage=currentLanguagePref.getLanguage();
          compatiblePref=true;
          currentScore=0;
          if (currentVariant.getLanguage().getMainTag().equals(currentLanguage.getMainTag())) {
            currentScore+=100;
          }
 else           if (!currentLanguage.getMainTag().equals("*")) {
            compatiblePref=false;
          }
 else           if (currentLanguage.getSubTag() != null) {
            compatiblePref=false;
          }
 else {
            currentScore++;
          }
          if (compatiblePref) {
            if ((currentLanguage.getSubTag() == null) || (currentVariant.getLanguage().getSubTag() == null)) {
              if (currentVariant.getLanguage().getSubTag() == currentLanguage.getSubTag()) {
                currentScore+=10;
              }
 else {
              }
            }
 else             if (currentLanguage.getSubTag().equals(currentVariant.getLanguage().getSubTag())) {
              currentScore+=10;
            }
 else {
              compatiblePref=false;
            }
            if (compatiblePref && ((bestLanguagePref == null) || (currentScore > bestLanguageScore))) {
              bestLanguagePref=currentLanguagePref;
              bestLanguageScore=currentScore;
            }
          }
        }
      }
      compatibleLanguage=(currentVariant.getLanguage() == null) || (bestLanguagePref != null) || (currentVariant.getLanguage().equals(fallbackLanguage));
      if (getPreference().getMediaTypes() != null) {
        for (Iterator<MediaTypePref> iter2=getPreference().getMediaTypes().iterator(); compatibleLanguage && iter2.hasNext(); ) {
          currentMediaTypePref=iter2.next();
          currentMediaType=currentMediaTypePref.getMediaType();
          compatiblePref=true;
          currentScore=0;
          if (currentMediaType.getMainType().equals(currentVariant.getMediaType().getMainType())) {
            currentScore+=1000;
          }
 else           if (!currentMediaType.getMainType().equals("*")) {
            compatiblePref=false;
          }
 else           if (!currentMediaType.getSubType().equals("*")) {
            compatiblePref=false;
          }
          if (compatiblePref) {
            if (currentVariant.getMediaType().getSubType().equals(currentMediaType.getSubType())) {
              currentScore+=100;
            }
 else             if (!currentMediaType.getSubType().equals("*")) {
              compatiblePref=false;
            }
            if (compatiblePref && (currentVariant.getMediaType().getParameters() != null)) {
              for (Iterator iter3=currentVariant.getMediaType().getParameters().iterator(); iter3.hasNext(); ) {
                currentParam=(Parameter)iter3.next();
                if (isParameterFound(currentParam,currentMediaType)) {
                  currentScore++;
                }
              }
            }
            if (compatiblePref && ((bestMediaTypePref == null) || (currentScore > bestMediaTypeScore))) {
              bestMediaTypePref=currentMediaTypePref;
              bestMediaTypeScore=currentScore;
            }
          }
        }
      }
      if (bestMediaTypePref != null) {
        float currentQuality=bestMediaTypePref.getQuality();
        if (bestLanguagePref != null) {
          currentQuality+=(bestLanguagePref.getQuality() * 10F);
        }
        if (bestVariant == null) {
          bestVariant=currentVariant;
          bestQuality=currentQuality;
        }
 else         if (currentQuality > bestQuality) {
          bestVariant=currentVariant;
          bestQuality=currentQuality;
        }
        bestLanguagePref=null;
        bestLanguageScore=0;
        bestMediaTypePref=null;
        bestMediaTypeScore=0;
      }
    }
    return bestVariant;
  }
}

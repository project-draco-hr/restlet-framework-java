def readmailcapfile(fp):
    'Read a mailcap file and return a dictionary keyed by MIME type.\n\n    Each MIME type is mapped to an entry consisting of a list of\n    dictionaries; the list will contain more than one such dictionary\n    if a given MIME type appears more than once in the mailcap file.\n    Each dictionary contains key-value pairs for that MIME type, where\n    the viewing command is stored with the key "view".\n    '
    caps = {}
    while 1:
        line = fp.readline()
        if (not line):
            break
        if ((line[0] == '#') or (line.strip() == '')):
            continue
        nextline = line
        while (nextline[(-2):] == '\\\n'):
            nextline = fp.readline()
            if (not nextline):
                nextline = '\n'
            line = (line[:(-2)] + nextline)
        (key, fields) = parseline(line)
        if (not (key and fields)):
            continue
        types = key.split('/')
        for j in range(len(types)):
            types[j] = types[j].strip()
        key = '/'.join(types).lower()
        if (key in caps):
            caps[key].append(fields)
        else:
            caps[key] = [fields]
    return caps

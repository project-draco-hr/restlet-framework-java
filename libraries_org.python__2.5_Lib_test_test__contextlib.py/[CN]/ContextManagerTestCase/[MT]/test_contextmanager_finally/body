def test_contextmanager_finally(self):
    state = []

    @contextmanager
    def woohoo():
        state.append(1)
        try:
            yield 42
        finally:
            state.append(999)
    try:
        with woohoo() as x:
            self.assertEqual(state, [1])
            self.assertEqual(x, 42)
            state.append(x)
            raise ZeroDivisionError()
    except ZeroDivisionError:
        pass
    else:
        self.fail('Expected ZeroDivisionError')
    self.assertEqual(state, [1, 42, 999])

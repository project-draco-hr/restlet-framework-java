{
  getAttributes().put(HeaderConstants.ATTRIBUTE_HEADERS,headers);
  if (protocol != null) {
    int slashIndex=protocol.indexOf('/');
    if (slashIndex != -1) {
      protocol=protocol.substring(slashIndex + 1);
    }
 else {
      protocol=null;
    }
  }
  String host=(getHeaders() == null) ? null : getHeaders().getFirstValue(HeaderConstants.HEADER_HOST,true);
  String hostDomain=null;
  int hostPort=-1;
  if (host != null) {
    int rightSquareBracketIndex=host.indexOf(']');
    boolean ipv4=(rightSquareBracketIndex == -1);
    if (ipv4) {
      int colonIndex=host.indexOf(':');
      if (colonIndex != -1) {
        hostDomain=host.substring(0,colonIndex);
        hostPort=Integer.valueOf(host.substring(colonIndex + 1));
      }
 else {
        hostDomain=host;
        hostPort=getProtocol().getDefaultPort();
      }
      Context.getCurrentLogger().fine("HttpInboundRequest::setHeaders, IPv4 hostDomain: " + hostDomain + ", hostPort: "+ hostPort);
    }
 else {
      if (rightSquareBracketIndex + 1 < host.length()) {
        hostDomain=host.substring(0,rightSquareBracketIndex + 1);
        hostPort=Integer.valueOf(host.substring(rightSquareBracketIndex + 2));
      }
 else       if (rightSquareBracketIndex + 1 == host.length()) {
        hostDomain=host;
        hostPort=getProtocol().getDefaultPort();
      }
      Context.getCurrentLogger().fine("HttpInboundRequest::setHeaders, IPv6 hostDomain: " + hostDomain + ", hostPort: "+ hostPort);
    }
  }
 else {
    Protocol serverProtocol=getConnection().getHelper().getHelped().getProtocols().get(0);
    if (!Protocol.SIP.getSchemeName().equals(serverProtocol.getSchemeName()) && !Protocol.SIPS.getSchemeName().equals(serverProtocol.getSchemeName())) {
      Context.getCurrentLogger().info("Couldn't find the mandatory \"Host\" HTTP header. Falling back to the IP address.");
      hostDomain=getConnection().getAddress();
      hostPort=getConnection().getPort();
      if (hostDomain == null) {
        hostDomain="localhost";
      }
      if (hostPort == -1) {
        hostPort=getConnection().getHelper().getHelped().getActualPort();
      }
      if (hostPort == -1) {
        getProtocol().getDefaultPort();
      }
    }
  }
  Protocol protocol=getConnection().getHelper().getHelped().getProtocols().get(0);
  StringBuilder sb=new StringBuilder();
  sb.append(protocol.getSchemeName()).append("://");
  sb.append(hostDomain);
  if ((hostPort != -1) && (hostPort != protocol.getDefaultPort())) {
    sb.append(':').append(hostPort);
  }
  setHostRef(sb.toString());
  if (resourceUri != null) {
    setResourceRef(new Reference(getHostRef(),resourceUri));
    if (getResourceRef().isRelative()) {
      if (!resourceUri.startsWith("/")) {
        setResourceRef(new Reference(getHostRef().toString() + "/" + resourceUri));
      }
 else {
        setResourceRef(new Reference(getHostRef().toString() + resourceUri));
      }
    }
    setOriginalRef(getResourceRef().getTargetRef());
  }
  String dateHeader=(getHeaders() == null) ? null : getHeaders().getFirstValue(HeaderConstants.HEADER_DATE,true);
  Date date=null;
  if (dateHeader != null) {
    date=DateUtils.parse(dateHeader);
  }
  if (date == null) {
    date=new Date();
  }
  setDate(date);
  String maxForwardsHeader=(getHeaders() == null) ? null : getHeaders().getFirstValue(HeaderConstants.HEADER_MAX_FORWARDS,true);
  if (maxForwardsHeader != null) {
    try {
      setMaxForwards(Integer.parseInt(maxForwardsHeader));
    }
 catch (    NumberFormatException nfe) {
      Context.getCurrentLogger().info("Unable to parse the Max-Forwards header: " + maxForwardsHeader);
    }
  }
}

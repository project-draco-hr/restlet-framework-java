{
  Boolean auth=false;
  request.setCacheDirectives(no);
  response.setCacheDirectives(no);
  redirectUri=request.getResourceRef().toUrl().toString();
  Form query=new Form(request.getOriginalRef().getQuery());
  String code=query.getFirstValue("code");
  getLogger().fine("Incomming request query = " + query);
  if (code == null) {
    Form form=new Form();
    form.add("type","web_server");
    form.add("client_id",params.getClientId());
    form.add("redirect_uri",redirectUri);
    form.add("scope",Scopes.toScope(params.getRoles()));
    try {
      form.encode();
    }
 catch (    IOException ioe) {
      getLogger().warning(ioe.getMessage());
    }
    String q=form.getQueryString();
    getLogger().fine("TEST query = " + q);
    Reference redirRef=new Reference(params.getBaseRef(),params.getAuthorizePath(),q,null);
    getLogger().fine("Redirecting to : " + redirRef.toUri());
    response.redirectSeeOther(redirRef);
    getLogger().fine("After Redirecting to : " + redirRef.toUri());
  }
 else {
    getLogger().fine("Came back after SNS code = " + code);
    ClientResource graphResource=new ClientResource(params.getBaseRef());
    ClientResource tokenResource=graphResource.getChild(params.getAccessTokenPath());
    Form form=new Form();
    form.add("type","web_server");
    form.add("client_id",params.getClientId());
    String redir=request.getResourceRef().getHostIdentifier() + request.getResourceRef().getPath();
    form.add("redirect_uri",redir);
    form.add("client_secret",params.getClientSecret());
    form.add("code",code);
    Representation body=tokenResource.post(form.getWebRepresentation());
    if (tokenResource.getStatus().isSuccess()) {
      Form answer=new Form(body);
      getLogger().fine("Got answer on AccessToken = " + answer.toString());
      accessToken=answer.getFirstValue("access_token");
      getLogger().fine("AccessToken in changed OldOauthProxy = " + accessToken);
      request.getClientInfo().setUser(new OAuthUser(null,accessToken));
      request.getClientInfo().setAuthenticated(true);
      auth=true;
    }
    getLogger().fine("Before graph release");
    body.release();
    tokenResource.release();
    graphResource.release();
  }
  if (auth) {
    return CONTINUE;
  }
 else {
    if (response.getStatus().isSuccess() || response.getStatus().isServerError()) {
      response.setStatus(Status.CLIENT_ERROR_FORBIDDEN);
    }
    return STOP;
  }
}

{
  Reference<Map<TypeVariable,Type>> ref=typeVariablesCache.get(clazz);
  Map<TypeVariable,Type> typeVariableMap=(ref != null ? ref.get() : null);
  if (typeVariableMap == null) {
    typeVariableMap=new HashMap<TypeVariable,Type>();
    getTypeVariables(clazz.getGenericInterfaces(),typeVariableMap);
    Type genericType=clazz.getGenericSuperclass();
    Class type=clazz.getSuperclass();
    while (type != null && !Object.class.equals(type)) {
      if (genericType instanceof ParameterizedType) {
        ParameterizedType pt=(ParameterizedType)genericType;
        populate(pt,typeVariableMap);
      }
      getTypeVariables(type.getGenericInterfaces(),typeVariableMap);
      genericType=type.getGenericSuperclass();
      type=type.getSuperclass();
    }
    type=clazz;
    while (type.isMemberClass()) {
      genericType=type.getGenericSuperclass();
      if (genericType instanceof ParameterizedType) {
        populate((ParameterizedType)genericType,typeVariableMap);
      }
      type=type.getEnclosingClass();
    }
    typeVariablesCache.put(clazz,new WeakReference<Map<TypeVariable,Type>>(typeVariableMap));
  }
  return typeVariableMap;
}

{
  int result=0;
  boolean continueReading=true;
  int beforeDrain=buffer.remaining();
  while (continueReading && isLineReadable()) {
    if (getMessageState() == MessageState.START) {
      if (getLineBuilder().length() == 0) {
        continueReading=false;
      }
 else {
        if (getHelper().getLogger().isLoggable(Level.FINE)) {
          getHelper().getLogger().fine("Reading message from " + getConnection().getSocketAddress());
        }
        readStartLine();
      }
    }
 else     if (getMessageState() == MessageState.HEADERS) {
      Parameter header=readHeader();
      if (header != null) {
        if (getHeaders() == null) {
          setHeaders(new Form());
        }
        getHeaders().add(header);
      }
 else {
        onReceived();
      }
    }
  }
  result=beforeDrain - buffer.remaining();
  if (getLogger().isLoggable(Level.FINER)) {
    getLogger().log(Level.FINER,result + " bytes read");
  }
  return result;
}

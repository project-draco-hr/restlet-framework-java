{
switch (getMessageState()) {
case START_LINE:
    writeStartLine();
  setMessageState(MessageState.HEADERS);
break;
case HEADERS:
if (getHeaders() == null) {
setHeaders(new Form());
setHeaderIndex(0);
addHeaders(getHeaders());
}
if (getHeaderIndex() < getHeaders().size()) {
Parameter header=getHeaders().get(getHeaderIndex());
getLineBuilder().append(header.getName());
getLineBuilder().append(": ");
getLineBuilder().append(header.getValue());
getLineBuilder().append('\r');
getLineBuilder().append('\n');
setHeaderIndex(getHeaderIndex() + 1);
}
 else {
getLineBuilder().append('\r');
getLineBuilder().append('\n');
if (getMessage().isEntityAvailable()) {
setMessageState(MessageState.BODY);
if (getMessage().getEntity() instanceof FileRepresentation) {
  FileRepresentation fr=(FileRepresentation)getMessage().getEntity();
  setEntityChannel(fr.getChannel());
  setEntityType(EntityType.FILE_CHANNEL);
}
 else if (getMessage().getEntity() instanceof ReadableRepresentation) {
  ReadableRepresentation rr=(ReadableRepresentation)getMessage().getEntity();
  setEntityChannel(rr.getChannel());
  setEntityType(EntityType.SYNC_CHANNEL);
  if (getEntityChannel() instanceof SelectableChannel) {
    SelectableChannel sc=(SelectableChannel)getEntityChannel();
    if (!sc.isBlocking()) {
      setEntityType(EntityType.ASYNC_CHANNEL);
    }
  }
}
 else {
  setEntityStream(getMessage().getEntity().getStream());
  setEntityType(EntityType.STREAM);
}
}
 else {
onCompleted(getMessage());
}
}
break;
}
}

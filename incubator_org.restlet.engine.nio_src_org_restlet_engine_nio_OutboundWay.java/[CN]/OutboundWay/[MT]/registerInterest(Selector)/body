{
  int socketInterest=0;
  int entityInterest=0;
  try {
    if (getIoState() == IoState.WRITE_INTEREST) {
      socketInterest=socketInterest | SelectionKey.OP_WRITE;
    }
 else     if (getIoState() == IoState.READ_INTEREST) {
      entityInterest=entityInterest | SelectionKey.OP_READ;
    }
    if (socketInterest > 0) {
      getConnection().getSocketChannel().register(selector,socketInterest,this);
    }
    if (entityInterest > 0) {
      Representation entity=(getMessage() == null) ? null : getMessage().getEntity();
      if (entity instanceof ReadableRepresentation) {
        ReadableRepresentation readableEntity=(ReadableRepresentation)entity;
        try {
          if (readableEntity.getChannel() instanceof SelectableChannel) {
            SelectableChannel selectableChannel=(SelectableChannel)readableEntity.getChannel();
            if (!selectableChannel.isBlocking()) {
              selectableChannel.register(selector,entityInterest,this);
            }
          }
        }
 catch (        IOException e) {
          e.printStackTrace();
        }
      }
    }
  }
 catch (  ClosedChannelException cce) {
    getLogger().log(Level.WARNING,"Unable to register NIO interest operations for this connection",cce);
    getConnection().setState(ConnectionState.CLOSING);
  }
}

{
  Writer tmplWriter=null;
  try {
    if (getCharacterSet() != null) {
      tmplWriter=new BufferedWriter(new OutputStreamWriter(outputStream,getCharacterSet().getName()));
    }
 else {
      if (getTemplate().getEncoding() == null) {
        tmplWriter=new BufferedWriter(new OutputStreamWriter(outputStream));
      }
 else {
        tmplWriter=new BufferedWriter(new OutputStreamWriter(outputStream,getTemplate().getEncoding()));
      }
    }
    getTemplate().merge(getContext(),tmplWriter);
    tmplWriter.flush();
  }
 catch (  Exception e) {
    Context context=Context.getCurrent();
    if (context != null) {
      context.getLogger().log(Level.WARNING,"Unable to process the template",e);
    }
    e.printStackTrace();
    throw new IOException("Template processing error. " + e.getMessage());
  }
}

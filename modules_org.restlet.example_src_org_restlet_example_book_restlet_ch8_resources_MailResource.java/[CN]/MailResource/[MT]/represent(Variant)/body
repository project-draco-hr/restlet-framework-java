{
  Map<String,Object> dataModel=new TreeMap<String,Object>();
  dataModel.put("currentUser",getCurrentUser());
  dataModel.put("mailbox",mailbox);
  dataModel.put("mail",mail);
  List<Contact> contacts=new ArrayList<Contact>();
  contacts.addAll(mailbox.getContacts());
  if (mail.getRecipients() != null) {
    for (    Contact contact : mail.getRecipients()) {
      if (contact.getId() == null) {
        contacts.add(contact);
      }
    }
  }
  dataModel.put("contacts",contacts);
  dataModel.put("resourceRef",getRequest().getResourceRef());
  dataModel.put("rootRef",getRequest().getRootRef());
  return getHTMLTemplateRepresentation("mail_" + mail.getStatus() + ".html",dataModel);
}

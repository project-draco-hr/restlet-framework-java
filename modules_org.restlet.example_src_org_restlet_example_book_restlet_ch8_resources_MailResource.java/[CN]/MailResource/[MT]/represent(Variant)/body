{
  final Map<String,Object> dataModel=new TreeMap<String,Object>();
  dataModel.put("currentUser",getCurrentUser());
  dataModel.put("mailbox",this.mailbox);
  dataModel.put("mail",this.mail);
  final List<Contact> contacts=new ArrayList<Contact>();
  contacts.addAll(this.mailbox.getContacts());
  if (this.mail.getRecipients() != null) {
    for (    final Contact contact : this.mail.getRecipients()) {
      if (contact.getId() == null) {
        contacts.add(contact);
      }
    }
  }
  dataModel.put("contacts",contacts);
  dataModel.put("resourceRef",getRequest().getResourceRef());
  dataModel.put("rootRef",getRequest().getRootRef());
  return getHTMLTemplateRepresentation("mail_" + this.mail.getStatus() + ".html",dataModel);
}

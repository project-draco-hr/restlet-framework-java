{
  if (challenge.getIdentifier() != null) {
    hb.appendQuotedParameter("username",challenge.getIdentifier());
  }
  if (challenge.getRealm() != null) {
    hb.appendQuotedParameter("realm",challenge.getRealm());
  }
  if (challenge.getServerNonce() != null) {
    hb.appendQuotedParameter("nonce",challenge.getServerNonce());
  }
  if (challenge.getDigestRef() != null) {
    hb.appendQuotedParameter("uri",challenge.getDigestRef().toString());
  }
  if (challenge.getSecret() != null) {
    if (challenge.getSecret() != null) {
      String a1=new String(challenge.getSecret());
      String a2=DigestUtils.toMd5(request.getMethod() + ":" + challenge.getDigestRef().toString());
      StringBuilder response=new StringBuilder().append(a1).append(':').append(challenge.getServerNonce());
      if (!AuthenticatorUtils.anyNull(challenge.getQuality(),challenge.getClientNonce(),challenge.getServerNounceCount())) {
        response.append(':').append(AuthenticatorUtils.formatNonceCount(challenge.getServerNounceCount())).append(':').append(challenge.getClientNonce()).append(':').append(challenge.getQuality());
      }
      response.append(':').append(a2);
      hb.appendQuotedParameter("response",DigestUtils.toMd5(response.toString()));
    }
  }
  if ((challenge.getDigestAlgorithm() != null) && !Digest.ALGORITHM_MD5.equals(challenge.getDigestAlgorithm())) {
    hb.appendParameter("algorithm",challenge.getDigestAlgorithm());
  }
  if (challenge.getClientNonce() != null) {
    hb.appendQuotedParameter("cnonce",challenge.getClientNonce());
  }
  if (challenge.getOpaque() != null) {
    hb.appendQuotedParameter("opaque",challenge.getOpaque());
  }
  if (challenge.getQuality() != null) {
    hb.appendParameter("qop",challenge.getQuality());
  }
  if ((challenge.getQuality() != null) && (challenge.getServerNounceCount() > 0)) {
    hb.appendParameter("nc",challenge.getServerNounceCountAsHex());
  }
  for (  Parameter param : challenge.getParameters()) {
    if (HttpUtils.isToken(param.getValue())) {
      hb.appendParameter(param);
    }
 else {
      hb.appendQuotedParameter(param);
    }
  }
}

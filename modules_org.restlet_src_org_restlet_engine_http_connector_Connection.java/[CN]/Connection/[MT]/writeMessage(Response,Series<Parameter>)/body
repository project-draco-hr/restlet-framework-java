{
  if (message != null) {
    Representation entity=isClientSide() ? message.getRequest().getEntity() : message.getEntity();
    if (entity != null) {
      entity=entity.isAvailable() ? entity : null;
    }
    ConnectorService connectorService=ConnectorHelper.getConnectorService();
    if (connectorService != null) {
      connectorService.beforeSend(entity);
    }
    try {
      try {
        writeMessageHead(message,headers);
      }
 catch (      IOException ioe) {
        getLogger().log(Level.WARNING,"Exception while writing the message headers.",ioe);
        throw ioe;
      }
      if (entity != null) {
        boolean chunked=HeaderUtils.isChunkedEncoding(headers);
        OutputStream entityStream=null;
        WritableByteChannel entityChannel=null;
        try {
          entityChannel=getOutboundEntityChannel(chunked);
          entityStream=getOutboundEntityStream(chunked);
          writeMessageBody(entity,entityChannel,entityStream);
        }
 catch (        IOException ioe) {
          getLogger().log(Level.WARNING,"Exception while writing the message body.",ioe);
          throw ioe;
        }
        try {
          if (entityStream != null) {
            entityStream.flush();
            entityStream.close();
          }
        }
 catch (        IOException ioe) {
          getLogger().log(Level.FINE,"Exception while flushing and closing the entity stream.",ioe);
        }
      }
    }
 catch (    IOException ioe) {
      throw ioe;
    }
 finally {
      if (entity != null) {
        entity.release();
      }
      if (connectorService != null) {
        connectorService.afterSend(entity);
      }
    }
  }
}

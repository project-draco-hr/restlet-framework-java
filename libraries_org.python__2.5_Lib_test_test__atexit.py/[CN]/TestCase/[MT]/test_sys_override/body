def test_sys_override(self):
    s = StringIO.StringIO()
    sys.stdout = sys.stderr = s
    save_handlers = atexit._exithandlers
    atexit._exithandlers = []
    exfunc = sys.exitfunc
    sys.exitfunc = self.h1
    reload(atexit)
    try:
        atexit.register(self.h2)
        atexit._run_exitfuncs()
    finally:
        sys.stdout = sys.__stdout__
        sys.stderr = sys.__stderr__
        atexit._exithandlers = save_handlers
        sys.exitfunc = exfunc
    self.assertEqual(s.getvalue(), 'h2\nh1\n')

def test_order(self):
    s = StringIO.StringIO()
    sys.stdout = sys.stderr = s
    save_handlers = atexit._exithandlers
    atexit._exithandlers = []
    try:
        atexit.register(self.h1)
        atexit.register(self.h2)
        atexit.register(self.h3)
        atexit._run_exitfuncs()
    finally:
        sys.stdout = sys.__stdout__
        sys.stderr = sys.__stderr__
        atexit._exithandlers = save_handlers
    self.assertEqual(s.getvalue(), 'h3\nh2\nh1\n')

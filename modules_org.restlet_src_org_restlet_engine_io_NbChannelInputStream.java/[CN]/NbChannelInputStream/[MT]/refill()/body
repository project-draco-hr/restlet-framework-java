{
  int bytesRead=0;
  while (bytesRead == 0) {
    bytesRead=readChannel();
    if (bytesRead == 0) {
      if (selectionChannel != null) {
        final CountDownLatch latch=new CountDownLatch(1);
        try {
          if (this.selectionRegistration == null) {
            this.selectionRegistration=this.selectionChannel.getRegistration();
            this.selectionRegistration.setInterestOperations(SelectionKey.OP_READ);
            this.selectionRegistration.setListener(new SelectionListener(){
              public void onSelected(              SelectionRegistration registration){
                registration.suspend();
                latch.countDown();
              }
            }
);
          }
 else {
            this.selectionRegistration.resume();
          }
          latch.await(IoUtils.IO_TIMEOUT,TimeUnit.MILLISECONDS);
        }
 catch (        Exception e) {
          Context.getCurrentLogger().log(Level.FINE,"Exception while registering or waiting for new content",e);
        }
        bytesRead=readChannel();
      }
 else       if (selectableChannel != null) {
        Selector selector=null;
        SelectionKey selectionKey=null;
        try {
          selector=SelectorFactory.getSelector();
          if (selector != null) {
            selectionKey=this.selectableChannel.register(selector,SelectionKey.OP_READ);
            selector.select(IoUtils.IO_TIMEOUT);
          }
        }
  finally {
          NioUtils.release(selector,selectionKey);
        }
        bytesRead=readChannel();
      }
    }
  }
  if (bytesRead == -1) {
    this.endReached=true;
    if (this.selectionRegistration != null) {
      this.selectionRegistration.cancel();
    }
  }
}

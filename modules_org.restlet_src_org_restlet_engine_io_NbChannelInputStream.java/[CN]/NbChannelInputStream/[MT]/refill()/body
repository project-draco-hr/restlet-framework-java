{
  int bytesRead=0;
  while (bytesRead == 0) {
    bytesRead=readChannel();
    if (bytesRead == 0) {
      if (selectionChannel != null) {
        try {
          if (this.selectionRegistration == null) {
            this.selectionRegistration=this.selectionChannel.getRegistration();
            this.selectionRegistration.setInterestOperations(SelectionKey.OP_READ);
            this.selectionRegistration.setSelectionListener(new SelectionListener(){
              public void onSelected(              SelectionRegistration registration) throws IOException {
                if (Context.getCurrentLogger().isLoggable(Level.FINER)) {
                  Context.getCurrentLogger().log(Level.FINER,"NbChannelInputStream selected");
                }
                selectionRegistration.suspend();
                selectionRegistration.unblock();
              }
            }
);
          }
 else {
            this.selectionRegistration.resume();
          }
          this.selectionRegistration.block();
          bytesRead=readChannel();
        }
 catch (        Exception e) {
          Context.getCurrentLogger().log(Level.FINE,"Exception while registering or waiting for new content",e);
        }
      }
 else       if (selectableChannel != null) {
        Selector selector=null;
        SelectionKey selectionKey=null;
        try {
          selector=SelectorFactory.getSelector();
          if (selector != null) {
            selectionKey=this.selectableChannel.register(selector,SelectionKey.OP_READ);
            selector.select(IoUtils.TIMEOUT_MS);
          }
        }
  finally {
          IoUtils.release(selector,selectionKey);
        }
        bytesRead=readChannel();
      }
    }
  }
  if (bytesRead == -1) {
    this.endReached=true;
    if (this.selectionRegistration != null) {
      this.selectionRegistration.setCanceling(true);
      this.selectionRegistration.setSelectionListener(null);
    }
  }
}

def tb_lineno(tb):
    'Calculate correct line number of traceback given in tb.\n\n    Even works with -O on.\n    '
    c = tb.tb_frame.f_code
    if (not hasattr(c, 'co_lnotab')):
        return tb.tb_lineno
    tab = c.co_lnotab
    line = c.co_firstlineno
    stopat = tb.tb_lasti
    addr = 0
    for i in range(0, len(tab), 2):
        addr = (addr + ord(tab[i]))
        if (addr > stopat):
            break
        line = (line + ord(tab[(i + 1)]))
    return line

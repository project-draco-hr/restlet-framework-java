{
  OAuthMessage requestMessage=OAuthHelper.getMessage(getRequest(),getLogger());
  OAuthAccessor accessor=provider.getAccessor(requestMessage);
  ChallengeRequest challengeRequest=new ChallengeRequest(OAuthGuard.SCHEME,realm);
  if (accessor == null) {
    getResponse().setChallengeRequest(challengeRequest);
    getResponse().setStatus(Status.CLIENT_ERROR_UNAUTHORIZED,"Invalid Consumer Key");
    challengeRequest.getParameters().add("oauth_problem","consumer_key_unknown");
    return;
  }
  try {
    requestMessage.validateSignature(accessor);
  }
 catch (  Exception e1) {
    getResponse().setChallengeRequest(challengeRequest);
    getResponse().setStatus(Status.CLIENT_ERROR_UNAUTHORIZED,"Invalid signature");
    challengeRequest.getParameters().add("oauth_problem","signature_invalid");
    return;
  }
  if (!Boolean.TRUE.equals(accessor.getProperty("authorized"))) {
    getResponse().setChallengeRequest(challengeRequest);
    getResponse().setStatus(Status.CLIENT_ERROR_UNAUTHORIZED,"Invalid / expired Token");
    challengeRequest.getParameters().add("oauth_problem","token_rejected");
    return;
  }
  provider.generateAccessToken(accessor);
  try {
    getResponse().setEntity(new StringRepresentation(OAuth.formEncode(OAuth.newList("oauth_token",accessor.accessToken,"oauth_token_secret",accessor.tokenSecret))));
  }
 catch (  IOException e) {
    e.printStackTrace();
  }
}

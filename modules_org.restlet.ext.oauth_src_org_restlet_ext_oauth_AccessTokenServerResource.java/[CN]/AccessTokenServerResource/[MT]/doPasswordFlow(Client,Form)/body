{
  AuthenticatedUser user=client.findUser(getUsername(params));
  if (user == null) {
    throw new OAuthException(OAuthError.invalid_request,"Authenticated user not found.",null);
  }
  String password=getPassword(params);
  if (!SecretVerifier.compare(user.getPassword(),password.toCharArray())) {
    throw new OAuthException(OAuthError.invalid_grant,"Password not correct.",null);
  }
  String[] requestedScope=getScope(params);
  refreshUserScopesAndPersist(user,requestedScope);
  Token token=this.generator.generateToken(user,this.tokenTimeSec);
  return responseTokenRepresentation(token,Scopes.toString(requestedScope));
}

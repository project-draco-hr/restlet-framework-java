def add(self, message):
    'Add message and return assigned key.'
    keys = self.keys()
    if (len(keys) == 0):
        new_key = 1
    else:
        new_key = (max(keys) + 1)
    new_path = os.path.join(self._path, str(new_key))
    f = _create_carefully(new_path)
    try:
        if self._locked:
            _lock_file(f)
        try:
            self._dump_message(message, f)
            if isinstance(message, MHMessage):
                self._dump_sequences(message, new_key)
        finally:
            if self._locked:
                _unlock_file(f)
    finally:
        _sync_close(f)
    return new_key

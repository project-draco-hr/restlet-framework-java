{
  int result=0;
  boolean continueReading=true;
  if (getManager().getState() == SslState.WRITING_APPLICATION_DATA) {
    getManager().setState(SslState.READING_APPLICATION_DATA);
  }
  while (continueReading) {
    getPacketBuffer().beforeFill();
    result+=drain(targetBuffer);
    continueReading=(getWrappedChannel().refill() > 0) || (getPacketBuffer().canDrain() && (getManager().getEngineStatus() == Status.OK));
  }
  return result;
}

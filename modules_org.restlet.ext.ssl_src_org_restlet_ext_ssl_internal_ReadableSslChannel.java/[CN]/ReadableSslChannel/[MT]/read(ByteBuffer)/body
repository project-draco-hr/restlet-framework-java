{
  int result=0;
  boolean continueReading=true;
  if (getConnection().getSslState() == SslState.WRITING_APPLICATION_DATA) {
    getConnection().setSslState(SslState.READING_APPLICATION_DATA);
  }
  while (continueReading) {
    result+=drain(targetBuffer);
    getPacketBuffer().beforeFill();
    continueReading=(getWrappedChannel().refill() > 0) || (getPacketBuffer().couldDrain() && (getConnection().getSslEngineStatus() == Status.OK));
  }
  return result;
}

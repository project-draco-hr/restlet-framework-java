{
  TunnelService tunnelService=getTunnelService();
  boolean extensionsModified=false;
  if (tunnelService.isPreferencesTunnel()) {
    Reference resourceRef=request.getResourceRef();
    if (resourceRef.hasExtensions()) {
      ClientInfo clientInfo=request.getClientInfo();
      boolean encodingFound=false;
      boolean characterSetFound=false;
      boolean mediaTypeFound=false;
      boolean languageFound=false;
      String extensions=resourceRef.getExtensions();
      for (; ; ) {
        int lastIndexOfPoint=extensions.lastIndexOf('.');
        String extension=extensions.substring(lastIndexOfPoint + 1);
        Metadata metadata=getMetadata(extension);
        if (!mediaTypeFound && (metadata instanceof MediaType)) {
          updateMetadata(clientInfo,metadata);
          mediaTypeFound=true;
        }
 else         if (!languageFound && (metadata instanceof Language)) {
          updateMetadata(clientInfo,metadata);
          languageFound=true;
        }
 else         if (!characterSetFound && (metadata instanceof CharacterSet)) {
          updateMetadata(clientInfo,metadata);
          characterSetFound=true;
        }
 else         if (!encodingFound && (metadata instanceof Encoding)) {
          updateMetadata(clientInfo,metadata);
          encodingFound=true;
        }
 else {
          break;
        }
        if (lastIndexOfPoint > 0) {
          extensions=extensions.substring(0,lastIndexOfPoint);
        }
 else {
          extensions="";
          break;
        }
      }
      if (mediaTypeFound || languageFound || encodingFound|| characterSetFound) {
        resourceRef.setExtensions(extensions);
        extensionsModified=true;
      }
    }
  }
  return extensionsModified;
}

{
  int result=0;
  if (getManager().getState() == SslState.READING_APPLICATION_DATA) {
    getManager().setState(SslState.WRITING_APPLICATION_DATA);
  }
  flush();
  if ((getPacketBufferState() == BufferState.FILLING) || (getManager().getState() == SslState.HANDSHAKING)) {
    int srcSize=src.remaining();
    if (srcSize > 0) {
      while (getPacketBuffer().hasRemaining() && (getConnection().getOutboundWay().getIoState() != IoState.IDLE) && src.hasRemaining()) {
        SSLEngineResult sslResult=runEngine(src);
        handleResult(sslResult,src);
        flush();
      }
      result=srcSize - src.remaining();
    }
  }
  return result;
}

{
  int totalRead=0;
  int currentRead=0;
  boolean tryAgain=true;
synchronized (getByteBuffer()) {
    while (tryAgain) {
switch (getByteBufferState()) {
case FILLED:
        setByteBufferState(BufferState.DRAINING);
case DRAINING:
      if (getByteBuffer().remaining() > 0) {
        if (getByteBuffer().remaining() >= targetBuffer.remaining()) {
          currentRead=targetBuffer.remaining();
          tryAgain=false;
        }
 else {
          currentRead=getByteBuffer().remaining();
        }
        for (int i=0; i < currentRead; i++) {
          targetBuffer.put(getByteBuffer().get());
        }
        totalRead+=currentRead;
      }
    if (getByteBuffer().remaining() == 0) {
      setByteBufferState(BufferState.FILLING);
      getByteBuffer().clear();
    }
  break;
case IDLE:
setByteBufferState(BufferState.FILLING);
case FILLING:
tryAgain=refill();
break;
}
}
}
return totalRead;
}

{
  int totalRead=0;
  int currentRead=0;
  boolean tryAgain=true;
synchronized (getByteBuffer()) {
    while (tryAgain) {
switch (getBufferState()) {
case FILLED:
        setBufferState(BufferState.DRAINING);
case DRAINING:
      if (getByteBuffer().remaining() == 0) {
        setBufferState(BufferState.FILLING);
        getByteBuffer().clear();
      }
 else {
        if (getByteBuffer().remaining() >= targetBuffer.remaining()) {
          currentRead=targetBuffer.remaining();
          tryAgain=false;
        }
 else {
          currentRead=getByteBuffer().remaining();
        }
        for (int i=0; i < currentRead; i++) {
          targetBuffer.put(getByteBuffer().get());
        }
        totalRead+=currentRead;
      }
    break;
case IDLE:
  setBufferState(BufferState.FILLING);
case FILLING:
tryAgain=refill();
break;
}
}
}
return totalRead;
}

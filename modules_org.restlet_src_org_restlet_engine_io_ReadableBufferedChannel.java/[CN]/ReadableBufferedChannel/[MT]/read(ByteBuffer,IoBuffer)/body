{
  int result=0;
  int lastRead=0;
  boolean tryAgain=true;
synchronized (getSourceBuffer().getBytes()) {
    while (tryAgain) {
switch (getSourceBuffer().getState()) {
case FILLED:
        getSourceBuffer().setState(BufferState.DRAINING);
case DRAINING:
      if (getSourceBuffer().getBytes().remaining() > 0) {
        lastRead=sourceBuffer.drain(targetBuffer);
        result+=lastRead;
        tryAgain=sourceBuffer.canRetry(lastRead,targetBuffer);
      }
    if (!getSourceBuffer().canDrain()) {
      getSourceBuffer().clear();
    }
  break;
case IDLE:
getSourceBuffer().setState(BufferState.FILLING);
case FILLING:
int refillCount=refill();
if (refillCount > 0) {
tryAgain=true;
}
 else if (refillCount == -1) {
result=-1;
tryAgain=false;
}
 else if (refillCount == 0) {
tryAgain=false;
}
break;
}
}
}
return result;
}

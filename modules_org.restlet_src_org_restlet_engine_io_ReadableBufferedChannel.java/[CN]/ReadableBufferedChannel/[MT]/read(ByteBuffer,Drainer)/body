{
  int result=0;
  int lastRead=0;
  boolean tryAgain=true;
synchronized (getByteBuffer()) {
    while (tryAgain) {
switch (getByteBufferState()) {
case FILLED:
        setByteBufferState(BufferState.DRAINING);
case DRAINING:
      if (getByteBuffer().remaining() > 0) {
        lastRead=drainer.drain(targetBuffer);
        result+=lastRead;
        tryAgain=drainer.canRetry(lastRead,targetBuffer);
      }
    if (getByteBuffer().remaining() == 0) {
      setByteBufferState(BufferState.FILLING);
      getByteBuffer().clear();
    }
  break;
case IDLE:
setByteBufferState(BufferState.FILLING);
case FILLING:
int refillCount=refill();
if (refillCount > 0) {
tryAgain=true;
}
 else if (refillCount == -1) {
result=-1;
tryAgain=false;
}
 else if (refillCount == 0) {
tryAgain=false;
}
break;
}
}
}
return result;
}

{
  TunnelService tunnelService=getTunnelService();
  boolean extensionsModified=false;
  Method method=request.getMethod();
  if (tunnelService.isPreferencesTunnel() && (method.equals(Method.GET) || method.equals(Method.HEAD))) {
    Reference resourceRef=request.getResourceRef();
    if (resourceRef.hasExtensions()) {
      ClientInfo clientInfo=request.getClientInfo();
      boolean encodingFound=false;
      boolean characterSetFound=false;
      boolean mediaTypeFound=false;
      boolean languageFound=false;
      String[] extensions=resourceRef.getExtensionsAsArray();
      StringBuilder sb=new StringBuilder();
      boolean extensionAdded=false;
      Metadata metadata=null;
      for (int i=extensions.length - 1; i >= 0; i--) {
        metadata=getMetadata(extensions[i]);
        if (!characterSetFound && (metadata instanceof CharacterSet)) {
          updateMetadata(clientInfo,metadata);
          characterSetFound=true;
        }
 else         if (!encodingFound && (metadata instanceof Encoding)) {
          updateMetadata(clientInfo,metadata);
          encodingFound=true;
        }
 else         if (!languageFound && (metadata instanceof Language)) {
          updateMetadata(clientInfo,metadata);
          languageFound=true;
        }
 else         if (!mediaTypeFound && (metadata instanceof MediaType)) {
          updateMetadata(clientInfo,metadata);
          mediaTypeFound=true;
        }
 else {
          if (extensionAdded) {
            sb.insert(0,'.');
          }
          sb.insert(0,extensions[i]);
          extensionAdded=true;
        }
      }
      if (characterSetFound || encodingFound || languageFound|| mediaTypeFound) {
        resourceRef.setExtensions(sb.toString());
        extensionsModified=true;
      }
    }
  }
  return extensionsModified;
}

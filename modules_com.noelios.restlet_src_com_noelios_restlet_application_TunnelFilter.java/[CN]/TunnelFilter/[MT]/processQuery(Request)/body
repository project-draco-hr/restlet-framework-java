{
  final TunnelService tunnelService=getTunnelService();
  boolean queryModified=false;
  final Reference resourceRef=request.getResourceRef();
  if (resourceRef.hasQuery()) {
    final Form query=resourceRef.getQueryAsForm(null);
    final Method method=request.getMethod();
    if (tunnelService.isMethodTunnel() && method.equals(Method.POST)) {
      final String methodName=query.getFirstValue(tunnelService.getMethodParameter());
      if (methodName != null) {
        request.setMethod(Method.valueOf(methodName));
        query.removeFirst(tunnelService.getMethodParameter());
        queryModified=true;
      }
    }
    if (tunnelService.isPreferencesTunnel()) {
      final String charSetParameter=tunnelService.getCharacterSetParameter();
      final String encodingParameter=tunnelService.getEncodingParameter();
      final String languageParameter=tunnelService.getLanguageParameter();
      final String mediaTypeParameter=tunnelService.getMediaTypeParameter();
      final String acceptedCharSet=query.getFirstValue(charSetParameter);
      final String acceptedEncoding=query.getFirstValue(encodingParameter);
      final String acceptedLanguage=query.getFirstValue(languageParameter);
      final String acceptedMediaType=query.getFirstValue(mediaTypeParameter);
      final ClientInfo clientInfo=request.getClientInfo();
      Metadata metadata=getMetadata(acceptedCharSet);
      if (metadata instanceof CharacterSet) {
        updateMetadata(clientInfo,metadata);
        query.removeFirst(charSetParameter);
        queryModified=true;
      }
      metadata=getMetadata(acceptedEncoding);
      if (metadata instanceof Encoding) {
        updateMetadata(clientInfo,metadata);
        query.removeFirst(encodingParameter);
        queryModified=true;
      }
      metadata=getMetadata(acceptedLanguage);
      if (metadata instanceof Language) {
        updateMetadata(clientInfo,metadata);
        query.removeFirst(languageParameter);
        queryModified=true;
      }
      metadata=getMetadata(acceptedMediaType);
      if (metadata instanceof MediaType) {
        updateMetadata(clientInfo,metadata);
        query.removeFirst(mediaTypeParameter);
        queryModified=true;
      }
    }
    if (queryModified) {
      request.getResourceRef().setQuery(query.getQueryString(null));
    }
  }
  return queryModified;
}

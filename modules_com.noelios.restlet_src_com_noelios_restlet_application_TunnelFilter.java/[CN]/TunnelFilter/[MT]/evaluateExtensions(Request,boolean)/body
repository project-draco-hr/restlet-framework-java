{
  Reference resourceRef=request.getResourceRef();
  String originalRef=resourceRef.toString();
  String path=resourceRef.getPath();
  MetadataService metadataService=getApplication().getMetadataService();
  float mediaTypeQuality=1;
  float languageQuality=1;
  float charsetQuality=1;
  float encodingQuality=1;
  StringBuilder cutExts=new StringBuilder();
  int lpsStart=path.lastIndexOf('/') + 1;
  String lps=path.substring(lpsStart);
  String matrixParams="";
  if (matrixParamsEnabled) {
    int lpsEnd=lps.indexOf(';');
    if (lpsEnd >= 0) {
      matrixParams=lps.substring(lpsEnd);
      lps=lps.substring(0,lpsEnd);
    }
  }
  String[] lpssa=lps.split("\\.");
  List<String> lpss=new ArrayList<String>(Arrays.asList(lpssa));
  Iterator<String> lpsIter=lpss.iterator();
  if (lpsIter.hasNext()) {
    lpsIter.next();
    ClientInfo clientInfo=request.getClientInfo();
    while (lpsIter.hasNext()) {
      String extension=lpsIter.next();
      Metadata metadata=metadataService.getMetadata(extension);
      if (metadata instanceof MediaType) {
        addPreference(metadata,mediaTypeQuality,clientInfo.getAcceptedMediaTypes(),mediaTypeQuality >= 0.99);
        mediaTypeQuality*=0.9;
        lpsIter.remove();
        cutExts.append('.');
        cutExts.append(extension);
      }
 else       if (metadata instanceof Language) {
        addPreference(metadata,languageQuality,clientInfo.getAcceptedLanguages(),languageQuality >= 0.99);
        languageQuality*=0.9;
        lpsIter.remove();
        cutExts.append('.');
        cutExts.append(extension);
      }
 else       if (metadata instanceof CharacterSet) {
        addPreference(metadata,charsetQuality,clientInfo.getAcceptedCharacterSets(),charsetQuality >= 0.99);
        charsetQuality*=0.9;
        lpsIter.remove();
        cutExts.append('.');
        cutExts.append(extension);
      }
 else       if (metadata instanceof Encoding) {
        addPreference(metadata,encodingQuality,clientInfo.getAcceptedEncodings(),encodingQuality >= 0.99);
        encodingQuality*=0.9;
        lpsIter.remove();
        cutExts.append('.');
        cutExts.append(extension);
      }
    }
  }
  StringBuilder newPath=new StringBuilder();
  newPath.append(path,0,lpsStart);
  lpsIter=lpss.iterator();
  if (lpsIter.hasNext()) {
    String pathPart=lpsIter.next();
    newPath.append(pathPart);
    while (lpsIter.hasNext()) {
      String ext=lpsIter.next();
      newPath.append('.');
      newPath.append(ext);
    }
  }
  newPath.append(matrixParams);
  resourceRef.setPath(newPath.toString());
  String cutExtsStr=null;
  if (cutExts.length() > 1)   cutExtsStr=cutExts.substring(1);
  Map<String,Object> attributes=request.getAttributes();
  attributes.put(TunnelService.REF_ORIGINAL_KEY,originalRef);
  attributes.put(TunnelService.REF_CUT_KEY,resourceRef.toString());
  attributes.put(TunnelService.REF_EXTENSIONS_KEY,cutExtsStr);
}

{
  Form query=request.getResourceRef().getQueryAsForm(null);
  boolean queryModified=false;
  TunnelService tunnelService=getApplication().getTunnelService();
  Method method=request.getMethod();
  if (tunnelService.isMethodTunnel() && method.equals(Method.POST)) {
    String methodName=query.getFirstValue(tunnelService.getMethodParameter());
    if (methodName != null) {
      request.setMethod(Method.valueOf(methodName));
      query.removeFirst(tunnelService.getMethodParameter());
      queryModified=true;
    }
  }
  if (tunnelService.isPreferencesTunnel()) {
    queryModified=evaluateQueryParameters(request,query,tunnelService);
  }
  if (tunnelService.isExtensionTunnel()) {
    evaluateExtensions(request,tunnelService.isMatrixParamsEnabled());
  }
  if (queryModified) {
    request.getResourceRef().setQuery(query.getQueryString(null));
  }
  return CONTINUE;
}

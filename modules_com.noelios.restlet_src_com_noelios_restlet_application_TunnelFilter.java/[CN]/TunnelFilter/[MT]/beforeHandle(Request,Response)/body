{
  super.beforeHandle(request,response);
  Form query=request.getResourceRef().getQueryAsForm(null);
  boolean queryModified=false;
  if (getApplication().getTunnelService().isMethodTunnel() && request.getMethod().equals(Method.POST)) {
    String methodName=query.getFirstValue(getApplication().getTunnelService().getMethodParameter());
    if (methodName != null) {
      request.setMethod(Method.valueOf(methodName));
      query.removeFirst(getApplication().getTunnelService().getMethodParameter());
      queryModified=true;
    }
  }
  if (request.getMethod().equals(Method.GET) && getApplication().getTunnelService().isPreferencesTunnel()) {
    String acceptCharset=query.getFirstValue(getApplication().getTunnelService().getCharacterSetParameter());
    String acceptEncoding=query.getFirstValue(getApplication().getTunnelService().getEncodingParameter());
    String acceptLanguage=query.getFirstValue(getApplication().getTunnelService().getLanguageParameter());
    String acceptMediaType=query.getFirstValue(getApplication().getTunnelService().getMediaTypeParameter());
    Metadata metadata=null;
    if (acceptCharset != null) {
      metadata=getApplication().getMetadataService().getMetadata(acceptCharset);
      if (metadata instanceof CharacterSet) {
        request.getClientInfo().getAcceptedCharacterSets().clear();
        request.getClientInfo().getAcceptedCharacterSets().add(new Preference<CharacterSet>((CharacterSet)metadata));
        query.removeFirst(getApplication().getTunnelService().getCharacterSetParameter());
        queryModified=true;
      }
    }
    if (acceptEncoding != null) {
      metadata=getApplication().getMetadataService().getMetadata(acceptEncoding);
      if (metadata instanceof Encoding) {
        request.getClientInfo().getAcceptedEncodings().clear();
        request.getClientInfo().getAcceptedEncodings().add(new Preference<Encoding>((Encoding)metadata));
        query.removeFirst(getApplication().getTunnelService().getEncodingParameter());
        queryModified=true;
      }
    }
    if (acceptLanguage != null) {
      metadata=getApplication().getMetadataService().getMetadata(acceptLanguage);
      if (metadata instanceof Language) {
        request.getClientInfo().getAcceptedLanguages().clear();
        request.getClientInfo().getAcceptedLanguages().add(new Preference<Language>((Language)metadata));
        query.removeFirst(getApplication().getTunnelService().getLanguageParameter());
        queryModified=true;
      }
    }
    if (acceptMediaType != null) {
      metadata=getApplication().getMetadataService().getMetadata(acceptMediaType);
      if (metadata instanceof MediaType) {
        request.getClientInfo().getAcceptedMediaTypes().clear();
        request.getClientInfo().getAcceptedMediaTypes().add(new Preference<MediaType>((MediaType)metadata));
        query.removeFirst(getApplication().getTunnelService().getMediaTypeParameter());
        queryModified=true;
      }
    }
  }
  if (queryModified) {
    request.getResourceRef().setQuery(query.getQueryString(null));
  }
}

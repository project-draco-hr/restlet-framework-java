{
  Reference originalRef=new Reference(request.getResourceRef().toString());
  boolean queryModified=false;
  boolean extensionsModified=false;
  if (getTunnelService().isQueryTunnel()) {
    queryModified=processQuery(request);
  }
  if (getTunnelService().isExtensionsTunnel()) {
    extensionsModified=processExtensions(request);
  }
  if (queryModified || extensionsModified) {
    request.getAttributes().put(TunnelService.ATTRIBUTE_ORIGINAL_REF,originalRef);
  }
  return CONTINUE;
}

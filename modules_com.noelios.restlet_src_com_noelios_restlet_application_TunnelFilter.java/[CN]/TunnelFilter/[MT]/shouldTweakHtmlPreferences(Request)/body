{
  boolean result=false;
  boolean shouldTweak=false;
  boolean allMediaTypesPreference=false;
  boolean htmlFound=false;
  boolean xmlFound=false;
  List<Preference<MediaType>> preferences=request.getClientInfo().getAcceptedMediaTypes();
  for (  Preference<MediaType> preference : preferences) {
    MediaType mediaType=preference.getMetadata();
    if (MediaType.ALL.equals(mediaType)) {
      allMediaTypesPreference=true;
      break;
    }
    if (!htmlFound && mediaType.getName().toLowerCase().contains("htm")) {
      htmlFound=true;
    }
 else     if (htmlFound && !xmlFound) {
      xmlFound=mediaType.getName().toLowerCase().contains("xml");
    }
  }
  shouldTweak=xmlFound && htmlFound;
  if (shouldTweak || allMediaTypesPreference) {
    Series<Parameter> requestHeaders=(Series<Parameter>)request.getAttributes().get(HttpConstants.ATTRIBUTE_HEADERS);
    Parameter parameter=requestHeaders.getFirst("X-Request-With",true);
    boolean ajaxClient=parameter != null && ("HTTP.Request".equalsIgnoreCase(parameter.getName()) || "XMLHttpRequest".equalsIgnoreCase(parameter.getName()));
    if (!ajaxClient) {
      result=allMediaTypesPreference;
    }
  }
  return result;
}

{
  final Reference resourceRef=request.getResourceRef();
  final Reference baseRef=resourceRef.getBaseRef();
  final String targetTemplate=getTargetTemplate();
  request.getAttributes().remove(HeaderConstants.ATTRIBUTE_HEADERS);
  request.setOnResponse(new Uniform(){
    public void handle(    Request req,    Response resp){
      if (!resp.getStatus().isInformational()) {
        response.setEntity(rewrite(response.getEntity()));
        response.getAttributes().remove(HeaderConstants.ATTRIBUTE_HEADERS);
        request.setResourceRef(resourceRef);
        if (response.getLocationRef() != null) {
          Template rt=new Template(targetTemplate);
          rt.setLogger(getLogger());
          int matched=rt.parse(response.getLocationRef().toString(),request);
          if (matched > 0) {
            String remainingPart=(String)request.getAttributes().get("rr");
            if (remainingPart != null) {
              response.setLocationRef(baseRef.toString() + remainingPart);
            }
          }
        }
        resp.commit();
      }
 else {
        SipResponse provisionalResponse=new SipResponse(request);
        provisionalResponse.setStatus(resp.getStatus());
        provisionalResponse.commit();
      }
    }
  }
);
  SipRequest r=new SipRequest((SipRequest)request);
  r.setResourceRef(targetRef);
  response.setAutoCommitting(false);
  next.handle(r,response);
}

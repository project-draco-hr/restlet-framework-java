def format_string(f, val, grouping=False):
    'Formats a string in the same way that the % formatting would use,\n    but takes the current locale into account.\n    Grouping is applied if the third parameter is true.'
    percents = list(_percent_re.finditer(f))
    new_f = _percent_re.sub('%s', f)
    if isinstance(val, tuple):
        new_val = list(val)
        i = 0
        for perc in percents:
            starcount = perc.group('modifiers').count('*')
            new_val[i] = format(perc.group(), new_val[i], grouping, False, *new_val[(i + 1):((i + 1) + starcount)])
            del new_val[(i + 1):((i + 1) + starcount)]
            i += (1 + starcount)
        val = tuple(new_val)
    elif operator.isMappingType(val):
        for perc in percents:
            key = perc.group('key')
            val[key] = format(perc.group(), val[key], grouping)
    else:
        val = format(percents[0].group(), val, grouping)
    return (new_f % val)

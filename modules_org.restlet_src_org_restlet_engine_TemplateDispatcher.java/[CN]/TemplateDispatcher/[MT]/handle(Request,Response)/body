{
  Response.setCurrent(response);
  Protocol protocol=request.getProtocol();
  if (protocol == null) {
    throw new UnsupportedOperationException("Unable to determine the protocol to use for this call.");
  }
  String targetUri=request.getResourceRef().toString(true,false);
  if (targetUri.contains("{")) {
    Template template=new Template(targetUri);
    request.setResourceRef(template.format(request,response));
  }
  doHandle(request,response);
  if ((response.getEntity() != null) && (response.getEntity().getLocation() == null)) {
    response.getEntity().setLocation(request.getResourceRef().toString());
  }
}

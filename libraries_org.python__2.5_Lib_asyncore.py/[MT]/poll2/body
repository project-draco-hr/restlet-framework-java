def poll2(timeout=0.0, map=None):
    if (map is None):
        map = socket_map
    if (timeout is not None):
        timeout = int((timeout * 1000))
    pollster = select.poll()
    if map:
        for (fd, obj) in map.items():
            flags = 0
            if obj.readable():
                flags |= (select.POLLIN | select.POLLPRI)
            if obj.writable():
                flags |= select.POLLOUT
            if flags:
                flags |= ((select.POLLERR | select.POLLHUP) | select.POLLNVAL)
                pollster.register(fd, flags)
        try:
            r = pollster.poll(timeout)
        except select.error as err:
            if (err[0] != EINTR):
                raise
            r = []
        for (fd, flags) in r:
            obj = map.get(fd)
            if (obj is None):
                continue
            readwrite(obj, flags)

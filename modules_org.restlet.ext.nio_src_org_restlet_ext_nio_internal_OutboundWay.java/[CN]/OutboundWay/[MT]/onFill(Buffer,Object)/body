{
  int remaining=buffer.remaining();
  if (getMessageState() == MessageState.BODY) {
    try {
      int filled=buffer.fill(getEntityChannel());
      if (filled == -1) {
        setMessageState(MessageState.END);
      }
    }
 catch (    IOException ioe) {
      if (getLogger().isLoggable(Level.WARNING)) {
        getLogger().log(Level.WARNING,"Unable to read the entity",ioe);
      }
      throw ioe;
    }
  }
 else   if (getMessageState() != MessageState.END) {
    if (getLineBuilder().length() == 0) {
      writeLine();
    }
    if (getLineBuilder().length() > 0) {
      if (remaining >= getLineBuilder().length()) {
        buffer.fill(StringUtils.getLatin1Bytes(getLineBuilder().toString()));
        if (getLogger().isLoggable(Level.FINE)) {
          String line=getLineBuilder().toString();
          line=line.substring(0,line.length() - 2);
          getLogger().log(Level.FINE,line);
        }
        clearLineBuilder();
      }
 else {
        buffer.fill(StringUtils.getLatin1Bytes(getLineBuilder().substring(0,remaining)));
        getLineBuilder().delete(0,remaining);
      }
    }
  }
  return remaining - buffer.remaining();
}

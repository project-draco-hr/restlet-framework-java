{
  Reference baseRef=request.getResourceRef().getBaseRef();
  request.setProtocol(null);
  request.setResourceRef(targetRef);
  request.getAttributes().remove(HeaderConstants.ATTRIBUTE_HEADERS);
  next.handle(request,response);
  response.setEntity(rewrite(response.getEntity()));
  response.getAttributes().remove(HeaderConstants.ATTRIBUTE_HEADERS);
  if (response.getLocationRef() != null) {
    Template rt=new Template(this.targetTemplate);
    rt.setLogger(getLogger());
    int matched=rt.parse(response.getLocationRef().toString(),request);
    if (matched > 0) {
      String remainingPart=(String)request.getAttributes().get("rr");
      if (remainingPart != null) {
        response.setLocationRef(baseRef.toString() + remainingPart);
      }
    }
  }
}

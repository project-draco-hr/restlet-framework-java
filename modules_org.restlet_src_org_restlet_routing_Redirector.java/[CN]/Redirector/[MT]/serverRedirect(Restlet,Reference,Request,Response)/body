{
  if (next == null) {
    getLogger().warning("No next Restlet provided for server redirection to " + targetRef);
  }
 else {
    Reference resourceRef=request.getResourceRef();
    Reference baseRef=resourceRef.getBaseRef();
    request.setProtocol(null);
    request.setResourceRef(targetRef);
    rewrite(request);
    next.handle(request,response);
    response.setEntity(rewrite(response.getEntity()));
    rewrite(response);
    request.setResourceRef(resourceRef);
    if (response.getLocationRef() != null) {
      Template rt=new Template(this.targetTemplate);
      rt.setLogger(getLogger());
      int matched=rt.parse(response.getLocationRef().toString(),request);
      if (matched > 0) {
        String remainingPart=(String)request.getAttributes().get("rr");
        if (remainingPart != null) {
          response.setLocationRef(baseRef.toString() + remainingPart);
        }
      }
    }
  }
}

{
  try {
    List<CookieSetting> cookies=call.getCookieSettings();
    for (int i=0; i < cookies.size(); i++) {
      getResponseHeaders().add(HttpConstants.HEADER_SET_COOKIE,CookieUtils.format(cookies.get(i)));
    }
    if (call.getRedirectRef() != null) {
      getResponseHeaders().add(HttpConstants.HEADER_LOCATION,call.getRedirectRef().toString());
    }
    if (call.getSecurity().getChallengeRequest() != null) {
      getResponseHeaders().add(HttpConstants.HEADER_WWW_AUTHENTICATE,SecurityUtils.format(call.getSecurity().getChallengeRequest()));
    }
    getResponseHeaders().add(HttpConstants.HEADER_SERVER,call.getServer().getName());
    if (call.getStatus() != null) {
      setResponseStatus(call.getStatus().getCode(),call.getStatus().getDescription());
    }
    if (call.getOutput() != null) {
      Representation output=call.getOutput();
      if (output.getExpirationDate() != null) {
        getResponseHeaders().add(HttpConstants.HEADER_EXPIRES,formatDate(output.getExpirationDate(),false));
      }
      if ((output.getEncoding() != null) && (!output.getEncoding().equals(Encoding.IDENTITY))) {
        getResponseHeaders().add(HttpConstants.HEADER_CONTENT_ENCODING,output.getEncoding().getName());
      }
      if (output.getLanguage() != null) {
        getResponseHeaders().add(HttpConstants.HEADER_CONTENT_LANGUAGE,output.getLanguage().getName());
      }
      if (output.getMediaType() != null) {
        StringBuilder contentType=new StringBuilder(output.getMediaType().getName());
        if (output.getCharacterSet() != null) {
          contentType.append("; charset=").append(output.getCharacterSet().getName());
        }
        getResponseHeaders().add(HttpConstants.HEADER_CONTENT_TYPE,contentType.toString());
      }
      if (output.getModificationDate() != null) {
        getResponseHeaders().add(HttpConstants.HEADER_LAST_MODIFIED,formatDate(output.getModificationDate(),false));
      }
      if (output.getTag() != null) {
        getResponseHeaders().add(HttpConstants.HEADER_ETAG,output.getTag().getName());
      }
      if (call.getOutput().getSize() != Representation.UNKNOWN_SIZE) {
        getResponseHeaders().add(HttpConstants.HEADER_CONTENT_LENGTH,Long.toString(call.getOutput().getSize()));
      }
      if (call.getOutput().getIdentifier() != null) {
        getResponseHeaders().add(HttpConstants.HEADER_CONTENT_LOCATION,call.getOutput().getIdentifier().toString());
      }
    }
  }
 catch (  Exception e) {
    logger.log(Level.INFO,"Exception intercepted",e);
    setResponseStatus(500,"An unexpected exception occured");
  }
}

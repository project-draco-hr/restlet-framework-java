{
  Response.setCurrent(response);
  final Protocol protocol=request.getProtocol();
  if (protocol == null) {
    throw new UnsupportedOperationException("Unable to determine the protocol to use for this call.");
  }
  final String targetUri=request.getResourceRef().toString(true,false);
  if (targetUri.contains("{")) {
    final Template template=new Template(getContext().getLogger(),targetUri);
    request.setResourceRef(template.format(request,response));
  }
  doHandle(request,response);
  if ((response.getEntity() != null) && (response.getEntity().getIdentifier() == null)) {
    response.getEntity().setIdentifier(request.getResourceRef().toString());
  }
}

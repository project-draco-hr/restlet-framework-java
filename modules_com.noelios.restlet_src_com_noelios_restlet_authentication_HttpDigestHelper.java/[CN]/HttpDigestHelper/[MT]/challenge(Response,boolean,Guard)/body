{
  super.challenge(response,stale,guard);
  if (stale) {
    response.getAttributes().put("stale","true");
  }
  ChallengeRequest mainChallengeRequest=null;
  for (  final ChallengeRequest challengeRequest : response.getChallengeRequests()) {
    if (challengeRequest.getScheme().equals(guard.getScheme())) {
      mainChallengeRequest=challengeRequest;
      break;
    }
  }
  final Series<Parameter> parameters=mainChallengeRequest.getParameters();
  final StringBuffer domain=new StringBuffer();
  for (  final String baseUri : guard.getDomainUris()) {
    domain.append(baseUri).append(' ');
  }
  if (domain.length() > 0) {
    domain.delete(domain.length() - 1,domain.length());
    parameters.add("domain",domain.toString());
  }
  parameters.add("nonce",SecurityUtils.makeNonce(guard.getServerKey()));
  if (response.getAttributes().containsKey("stale")) {
    parameters.add("stale","true");
  }
}

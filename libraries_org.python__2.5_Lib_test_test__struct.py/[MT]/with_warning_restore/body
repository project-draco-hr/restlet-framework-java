def with_warning_restore(func):

    def _with_warning_restore(*args, **kw):
        save_warnings_filters = warnings.filters[:]
        globals = func.func_globals
        if ('__warningregistry__' in globals):
            del globals['__warningregistry__']
        warnings.filterwarnings('error', '^struct.*', DeprecationWarning)
        warnings.filterwarnings('error', '.*format requires.*', DeprecationWarning)
        try:
            return func(*args, **kw)
        finally:
            warnings.filters[:] = save_warnings_filters[:]
    return _with_warning_restore

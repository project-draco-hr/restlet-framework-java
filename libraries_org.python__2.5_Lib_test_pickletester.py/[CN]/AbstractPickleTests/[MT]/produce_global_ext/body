def produce_global_ext(self, extcode, opcode):
    e = ExtensionSaver(extcode)
    try:
        copy_reg.add_extension(__name__, 'MyList', extcode)
        x = MyList([1, 2, 3])
        x.foo = 42
        x.bar = 'hello'
        s1 = self.dumps(x, 1)
        self.assert_((__name__ in s1))
        self.assert_(('MyList' in s1))
        self.assertEqual(opcode_in_pickle(opcode, s1), False)
        y = self.loads(s1)
        self.assertEqual(list(x), list(y))
        self.assertEqual(x.__dict__, y.__dict__)
        s2 = self.dumps(x, 2)
        self.assert_((__name__ not in s2))
        self.assert_(('MyList' not in s2))
        self.assertEqual(opcode_in_pickle(opcode, s2), True)
        y = self.loads(s2)
        self.assertEqual(list(x), list(y))
        self.assertEqual(x.__dict__, y.__dict__)
    finally:
        e.restore()

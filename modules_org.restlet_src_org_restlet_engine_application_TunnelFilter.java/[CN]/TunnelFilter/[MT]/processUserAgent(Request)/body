{
  final Map<String,String> agentAttributes=request.getClientInfo().getAgentAttributes();
  if (agentAttributes != null) {
    if (getAcceptReplacers() != null) {
      final Form headers=(Form)request.getAttributes().get(HttpConstants.ATTRIBUTE_HEADERS);
      final String acceptOld=(headers != null) ? headers.getFirstValue(HttpConstants.HEADER_ACCEPT,true) : null;
      for (      AcceptReplacer acceptReplacer : this.acceptReplacers) {
        boolean checked=true;
        for (        Entry<String,String> entry : acceptReplacer.getAgentAttributes().entrySet()) {
          final String attribute=agentAttributes.get(entry.getKey());
          checked=checked && (attribute != null && attribute.equals(entry.getValue()));
        }
        if (checked) {
          if (acceptOld == null) {
            checked=acceptReplacer.getAcceptOld() == null;
          }
 else {
            checked=acceptOld.equals(acceptReplacer.getAcceptOld());
          }
          if (checked) {
            final ClientInfo clientInfo=new ClientInfo();
            PreferenceUtils.parseMediaTypes(acceptReplacer.getAcceptNew(),clientInfo);
            request.getClientInfo().setAcceptedMediaTypes(clientInfo.getAcceptedMediaTypes());
            break;
          }
        }
      }
    }
  }
}

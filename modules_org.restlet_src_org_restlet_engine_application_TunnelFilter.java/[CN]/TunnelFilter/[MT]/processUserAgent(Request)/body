{
  final Map<String,String> agentAttributes=request.getClientInfo().getAgentAttributes();
  if (agentAttributes != null) {
    if (getAcceptReplacers() != null) {
      final Form headers=(Form)request.getAttributes().get(HeaderConstants.ATTRIBUTE_HEADERS);
      final String acceptOld=(headers != null) ? headers.getFirstValue(HeaderConstants.HEADER_ACCEPT,true) : null;
      for (      AcceptReplacer acceptReplacer : this.acceptReplacers) {
        boolean checked=true;
        for (        String key : acceptReplacer.getAgentAttributes().keySet()) {
          final String attribute=agentAttributes.get(key);
          checked=checked && (attribute != null && attribute.equalsIgnoreCase(acceptReplacer.getAgentAttributes().get(key)));
        }
        if (checked) {
          if (acceptReplacer.getAcceptOld() != null) {
            checked=acceptReplacer.getAcceptOld().equals(acceptOld);
          }
          if (checked) {
            final ClientInfo clientInfo=new ClientInfo();
            PreferenceUtils.parseMediaTypes(acceptReplacer.getAcceptNew(),clientInfo);
            request.getClientInfo().setAcceptedMediaTypes(clientInfo.getAcceptedMediaTypes());
            break;
          }
        }
      }
    }
  }
}

def _parse_sub(source, state, nested=1):
    items = []
    while 1:
        items.append(_parse(source, state))
        if source.match('|'):
            continue
        if (not nested):
            break
        if ((not source.next) or source.match(')', 0)):
            break
        else:
            raise error, 'pattern not properly closed'
    if (len(items) == 1):
        return items[0]
    subpattern = SubPattern(state)
    while 1:
        prefix = None
        for item in items:
            if (not item):
                break
            if (prefix is None):
                prefix = item[0]
            elif (item[0] != prefix):
                break
        else:
            for item in items:
                del item[0]
            subpattern.append(prefix)
            continue
        break
    for item in items:
        if ((len(item) != 1) or (item[0][0] != LITERAL)):
            break
    else:
        set = []
        for item in items:
            set.append(item[0])
        subpattern.append((IN, set))
        return subpattern
    subpattern.append((BRANCH, (None, items)))
    return subpattern

{
  Logger l=Context.getCurrentLogger();
  String redir=request.getResourceRef().getHostIdentifier() + request.getResourceRef().getPath() + "?return=true";
  List<?> discoveries=null;
  discoveries=discovery.discover(target);
  for (  Object o : discoveries) {
    if (o instanceof DiscoveryInformation) {
      DiscoveryInformation di=(DiscoveryInformation)o;
      l.fine("Found - " + di.getOPEndpoint());
      target=di.getOPEndpoint().toString();
    }
  }
  ConsumerManager manager=getManager(target);
  DiscoveryInformation discovered=manager.associate(discoveries);
  String sessionId=String.valueOf(System.identityHashCode(discovered));
  session.put(sessionId,discovered);
  response.getCookieSettings().add(new CookieSetting(OpenIdConsumer.DESCRIPTOR_COOKIE,sessionId));
  AuthRequest authReq=manager.authenticate(discovered,redir);
  String ref=request.getResourceRef().getBaseRef().toString();
  l.fine("OpenID - REALM = " + ref);
  authReq.setRealm(ref);
  FetchRequest fetch=null;
  for (  AX o : this.optionalAttributes) {
    if (fetch == null)     fetch=FetchRequest.createFetchRequest();
    fetch.addAttribute(o.toString(),ax.get(o),false);
  }
  for (  AX r : this.requiredAttributes) {
    if (fetch == null)     fetch=FetchRequest.createFetchRequest();
    fetch.addAttribute(r.toString(),ax.get(r),true);
  }
  if (fetch != null) {
    authReq.addExtension(fetch);
  }
  if (!discovered.isVersion2()) {
    l.fine("OpenId - Http Redirect");
    response.redirectTemporary(authReq.getDestinationUrl(true));
  }
 else {
    l.fine("OpenId - HTML Form Redirect");
    Form msg=new Form();
    for (    Object key : authReq.getParameterMap().keySet()) {
      msg.add(key.toString(),authReq.getParameterValue(key.toString()));
      l.fine("Adding to form - key " + key.toString() + " : value"+ authReq.getParameterValue(key.toString()));
    }
    response.setEntity(generateForm(authReq));
  }
}

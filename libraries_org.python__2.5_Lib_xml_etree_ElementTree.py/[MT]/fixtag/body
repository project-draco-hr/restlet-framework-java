def fixtag(tag, namespaces):
    if isinstance(tag, QName):
        tag = tag.text
    (namespace_uri, tag) = string.split(tag[1:], '}', 1)
    prefix = namespaces.get(namespace_uri)
    if (prefix is None):
        prefix = _namespace_map.get(namespace_uri)
        if (prefix is None):
            prefix = ('ns%d' % len(namespaces))
        namespaces[namespace_uri] = prefix
        if (prefix == 'xml'):
            xmlns = None
        else:
            xmlns = (('xmlns:%s' % prefix), namespace_uri)
    else:
        xmlns = None
    return (('%s:%s' % (prefix, tag)), xmlns)

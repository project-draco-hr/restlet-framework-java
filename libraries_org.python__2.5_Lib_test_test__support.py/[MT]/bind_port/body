def bind_port(sock, host='', preferred_port=54321):
    "Try to bind the sock to a port.  If we are running multiple\n    tests and we don't try multiple ports, the test can fails.  This\n    makes the test more robust."
    import socket, errno
    for port in [preferred_port, 9907, 10243, 32999, 0]:
        try:
            sock.bind((host, port))
            if (port == 0):
                port = sock.getsockname()[1]
            return port
        except socket.error as (err, msg):
            if (err != errno.EADDRINUSE):
                raise
            print  >> sys.__stderr__, ('  WARNING: failed to listen on port %d, trying another' % port)
    raise TestFailed, 'unable to find port to listen on'

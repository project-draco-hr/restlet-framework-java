{
  if ((this.channel != null) && (this.bb != null)) {
    try {
      int bytesWritten;
      int attempts=0;
      while (this.bb.hasRemaining()) {
        bytesWritten=this.channel.write(this.bb);
        attempts++;
        if (bytesWritten < 0) {
          throw new EOFException("Unexpected negative number of bytes written. End of file detected.");
        }
 else         if (bytesWritten == 0) {
          if (this.selectableChannel != null) {
            if (this.selector == null) {
              this.selector=SelectorFactory.getSelector();
            }
            if (this.selector == null) {
              if (attempts > 2) {
                throw new IOException("Unable to obtain a selector. Selector factory returned null.");
              }
            }
 else {
              this.selectionKey=this.selectableChannel.register(this.selector,SelectionKey.OP_WRITE);
              if (this.selector.select(NioUtils.NIO_TIMEOUT) == 0) {
                if (attempts > 2) {
                  throw new IOException("Unable to select the channel to write to it. Selection timed out.");
                }
              }
 else {
                attempts--;
              }
            }
          }
        }
 else {
          attempts=0;
        }
      }
    }
 catch (    IOException ioe) {
      throw new IOException("Unable to write to the non-blocking channel. " + ioe.getLocalizedMessage());
    }
 finally {
      this.bb.clear();
    }
  }
 else {
    throw new IOException("Unable to write. Null byte buffer or channel detected.");
  }
}

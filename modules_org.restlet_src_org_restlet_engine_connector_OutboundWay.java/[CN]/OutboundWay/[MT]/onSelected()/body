{
  try {
    Response message=getMessage();
    if (message != null) {
      super.onSelected();
      while (isSelected()) {
        if (getIoBuffer().isFilling()) {
          if (getMessageState() == MessageState.END) {
            onCompleted(false);
          }
 else {
            fillIoBuffer();
          }
        }
 else         if (getIoBuffer().isDraining()) {
          drainIoBuffer();
          if (getMessageState() == MessageState.IDLE) {
            updateState();
          }
        }
      }
    }
  }
 catch (  Exception e) {
    getLogger().log(Level.FINE,"Error while writing a message. Closing the connection.",e);
    getConnection().onError("Error while writing a message. Closing the connection.",e,Status.CONNECTOR_ERROR_COMMUNICATION);
  }
}

{
  while (isSelected() && getIoBuffer().canFill() && (getMessageState() != MessageState.END)) {
    if (getMessageState() == MessageState.BODY) {
      int result=getEntityChannel().read(getIoBuffer().getBytes());
      if (result == -1) {
        setMessageState(MessageState.END);
      }
    }
 else {
      if (getLineBuilder().length() == 0) {
        writeLine();
      }
      if (getLineBuilder().length() > 0) {
        int remaining=getIoBuffer().getBytes().remaining();
        if (remaining >= getLineBuilder().length()) {
          getIoBuffer().getBytes().put(StringUtils.getLatin1Bytes(getLineBuilder().toString()));
          clearLineBuilder();
        }
 else {
          getIoBuffer().getBytes().put(StringUtils.getLatin1Bytes(getLineBuilder().substring(0,remaining)));
          getLineBuilder().delete(0,remaining);
        }
      }
    }
  }
  if (getIoBuffer().getBytes().position() > 0) {
    getIoBuffer().getBytes().flip();
    getIoBuffer().setState(BufferState.DRAINING);
  }
}

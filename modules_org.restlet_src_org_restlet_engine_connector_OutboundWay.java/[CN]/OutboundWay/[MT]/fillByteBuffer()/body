{
  while (isSelected() && getIoBuffer().canFill() && (getMessageState() != MessageState.END)) {
    if (getMessageState() == MessageState.BODY) {
      int result=getIoBuffer().fill(getEntityChannel());
      if (result == -1) {
        setMessageState(MessageState.END);
      }
    }
 else {
      if (getLineBuilder().length() == 0) {
        writeLine();
      }
      if (getLineBuilder().length() > 0) {
        int remaining=getIoBuffer().remaining();
        if (remaining >= getLineBuilder().length()) {
          getIoBuffer().fill(StringUtils.getLatin1Bytes(getLineBuilder().toString()));
          clearLineBuilder();
        }
 else {
          getIoBuffer().fill(StringUtils.getLatin1Bytes(getLineBuilder().substring(0,remaining)));
          getLineBuilder().delete(0,remaining);
        }
      }
    }
  }
  getIoBuffer().flip();
}

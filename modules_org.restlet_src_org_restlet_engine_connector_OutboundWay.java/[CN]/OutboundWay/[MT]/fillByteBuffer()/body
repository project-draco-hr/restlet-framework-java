{
  while (isProcessing() && getByteBuffer().hasRemaining()) {
    if (getMessageState() == MessageState.BODY) {
      int result=getEntityChannel().read(getByteBuffer());
      if (result == -1) {
        setMessageState(MessageState.END);
        onCompleted();
      }
    }
 else {
      if (getLineBuilder().length() == 0) {
        writeLine();
      }
      if (getLineBuilder().length() > 0) {
        int remaining=getByteBuffer().remaining();
        if (remaining >= getLineBuilder().length()) {
          getByteBuffer().put(StringUtils.getLatin1Bytes(getLineBuilder().toString()));
          clearLineBuilder();
        }
 else {
          getByteBuffer().put(StringUtils.getLatin1Bytes(getLineBuilder().substring(0,remaining)));
          getLineBuilder().delete(0,remaining);
        }
      }
    }
  }
  if (getByteBuffer().position() > 0) {
    getByteBuffer().flip();
    setByteBufferState(BufferState.DRAINING);
  }
}

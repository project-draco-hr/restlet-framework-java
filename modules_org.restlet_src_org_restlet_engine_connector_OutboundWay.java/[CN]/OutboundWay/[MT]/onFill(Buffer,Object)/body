{
  int remaining=buffer.remaining();
  if (getMessageState() == MessageState.BODY) {
    int filled=buffer.fill(getEntityChannel());
    if (filled == -1) {
      setMessageState(MessageState.END);
    }
  }
 else   if (getMessageState() != MessageState.END) {
    if (getLineBuilder().length() == 0) {
      writeLine();
    }
    if (getLineBuilder().length() > 0) {
      if (remaining >= getLineBuilder().length()) {
        buffer.fill(StringUtils.getLatin1Bytes(getLineBuilder().toString()));
        clearLineBuilder();
      }
 else {
        buffer.fill(StringUtils.getLatin1Bytes(getLineBuilder().substring(0,remaining)));
        getLineBuilder().delete(0,remaining);
      }
    }
  }
  return remaining - buffer.remaining();
}

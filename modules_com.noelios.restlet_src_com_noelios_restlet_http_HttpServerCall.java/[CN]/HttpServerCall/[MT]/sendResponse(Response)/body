{
  if (response != null) {
    try {
      writeResponseHead(response);
      final Representation entity=response.getEntity();
      if (entity != null) {
        final ConnectorService connectorService=getConnectorService(response.getRequest());
        if (connectorService != null) {
          connectorService.beforeSend(entity);
        }
        final WritableByteChannel responseEntityChannel=getResponseEntityChannel();
        final OutputStream responseEntityStream=getResponseEntityStream();
        writeResponseBody(entity,responseEntityChannel,responseEntityStream);
        if (connectorService != null) {
          connectorService.afterSend(entity);
        }
        if (responseEntityStream != null) {
          try {
            responseEntityStream.flush();
            responseEntityStream.close();
          }
 catch (          final IOException ioe) {
            getLogger().log(Level.FINE,"Exception while flushing and closing the entity stream.",ioe);
          }
        }
      }
    }
  finally {
      final Representation entity=response.getEntity();
      if (entity != null) {
        entity.release();
      }
    }
  }
}

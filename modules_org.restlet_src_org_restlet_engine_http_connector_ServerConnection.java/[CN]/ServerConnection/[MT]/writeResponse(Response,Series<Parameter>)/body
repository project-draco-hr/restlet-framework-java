{
  if (response != null) {
    Representation responseEntity=response.getEntity();
    ConnectorService connectorService=ConnectorHelper.getConnectorService(response.getRequest());
    if (connectorService != null) {
      connectorService.beforeSend(responseEntity);
    }
    try {
      writeResponseHead(response,headers);
      if (responseEntity != null) {
        boolean chunked=HeaderUtils.isChunkedEncoding(headers);
        WritableByteChannel responseEntityChannel=getOutboundEntityChannel(chunked);
        OutputStream responseEntityStream=getOutboundEntityStream(chunked);
        writeResponseBody(responseEntity,responseEntityChannel,responseEntityStream);
        if (responseEntityStream != null) {
          responseEntityStream.flush();
          responseEntityStream.close();
        }
      }
    }
 catch (    IOException ioe) {
      getLogger().log(Level.FINE,"Exception while flushing and closing the entity stream.",ioe);
    }
 finally {
      setOutboundBusy(false);
      if (responseEntity != null) {
        responseEntity.release();
      }
      if (connectorService != null) {
        connectorService.afterSend(responseEntity);
      }
    }
  }
}

{
  if (this.clientAddress == null) {
    boolean useForwardedFor=Boolean.valueOf(System.getProperty(PROPERTY_USE_FORWARDED_FOR));
    if (useForwardedFor) {
      Parameter header;
      for (Iterator<Parameter> iter=getRequestHeaders().iterator(); iter.hasNext(); ) {
        header=iter.next();
        if (header.getName().equalsIgnoreCase(HEADER_X_FORWARDED_FOR)) {
          int index=header.getValue().lastIndexOf(',');
          if (index == -1) {
            this.clientAddress=header.getValue().trim();
          }
 else {
            this.clientAddress=header.getValue().substring(index + 1).trim();
          }
        }
      }
      if ((this.clientAddress == null) || this.clientAddress.equalsIgnoreCase("unknown")) {
        this.clientAddress=getRequestAddress();
      }
    }
 else {
      this.clientAddress=getRequestAddress();
    }
  }
  return this.clientAddress;
}

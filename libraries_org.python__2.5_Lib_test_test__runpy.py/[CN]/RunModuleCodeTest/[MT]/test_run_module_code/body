def test_run_module_code(self):
    initial = object()
    name = '<Nonsense>'
    file = 'Some other nonsense'
    loader = "Now you're just being silly"
    d1 = dict(initial=initial)
    saved_argv0 = sys.argv[0]
    d2 = _run_module_code(self.test_source, d1, name, file, loader, True)
    self.failUnless(('result' not in d1))
    self.failUnless((d2['initial'] is initial))
    self.failUnless((d2['result'] == self.expected_result))
    self.failUnless((d2['nested']['x'] == 1))
    self.failUnless((d2['__name__'] is name))
    self.failUnless((d2['run_name'] is name))
    self.failUnless((d2['__file__'] is file))
    self.failUnless((d2['run_argv0'] is file))
    self.failUnless((d2['__loader__'] is loader))
    self.failUnless((sys.argv[0] is saved_argv0))
    self.failUnless((name not in sys.modules))

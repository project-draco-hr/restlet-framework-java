def _RealGetContents(self):
    'Read in the table of contents for the ZIP file.'
    fp = self.fp
    fp.seek((-22), 2)
    filesize = (fp.tell() + 22)
    endrec = fp.read(22)
    if ((endrec[0:4] != stringEndArchive) or (endrec[(-2):] != '\x00\x00')):
        raise BadZipfile, 'File is not a zip file, or ends with a comment'
    endrec = struct.unpack(structEndArchive, endrec)
    if (self.debug > 1):
        print endrec
    size_cd = endrec[5]
    offset_cd = endrec[6]
    x = ((filesize - 22) - size_cd)
    concat = (x - offset_cd)
    if (self.debug > 2):
        print 'given, inferred, offset', offset_cd, x, concat
    self.start_dir = (offset_cd + concat)
    fp.seek(self.start_dir, 0)
    total = 0
    while (total < size_cd):
        centdir = fp.read(46)
        total = (total + 46)
        if (centdir[0:4] != stringCentralDir):
            raise BadZipfile, 'Bad magic number for central directory'
        centdir = struct.unpack(structCentralDir, centdir)
        if (self.debug > 2):
            print centdir
        filename = fp.read(centdir[_CD_FILENAME_LENGTH])
        x = ZipInfo(filename)
        x.extra = fp.read(centdir[_CD_EXTRA_FIELD_LENGTH])
        x.comment = fp.read(centdir[_CD_COMMENT_LENGTH])
        total = (((total + centdir[_CD_FILENAME_LENGTH]) + centdir[_CD_EXTRA_FIELD_LENGTH]) + centdir[_CD_COMMENT_LENGTH])
        x.header_offset = (centdir[_CD_LOCAL_HEADER_OFFSET] + concat)
        (x.create_version, x.create_system, x.extract_version, x.reserved, x.flag_bits, x.compress_type, t, d, x.CRC, x.compress_size, x.file_size) = centdir[1:12]
        (x.volume, x.internal_attr, x.external_attr) = centdir[15:18]
        x.date_time = (((d >> 9) + 1980), ((d >> 5) & 15), (d & 31), (t >> 11), ((t >> 5) & 63), ((t & 31) * 2))
        self.filelist.append(x)
        self.NameToInfo[x.filename] = x
        if (self.debug > 2):
            print 'total', total
    for data in self.filelist:
        fp.seek(data.header_offset, 0)
        fheader = fp.read(30)
        if (fheader[0:4] != stringFileHeader):
            raise BadZipfile, 'Bad magic number for file header'
        fheader = struct.unpack(structFileHeader, fheader)
        data.file_offset = (((data.header_offset + 30) + fheader[_FH_FILENAME_LENGTH]) + fheader[_FH_EXTRA_FIELD_LENGTH])
        fname = fp.read(fheader[_FH_FILENAME_LENGTH])
        if (fname != data.orig_filename):
            raise RuntimeError, ('File name in directory "%s" and header "%s" differ.' % (data.orig_filename, fname))

{
  AuthenticatedUser user=null;
  if (client.containsUser(userId)) {
    user=client.findUser(userId);
  }
 else {
    user=client.createUser(userId);
  }
  String code=generator.generateCode(user);
  StringBuilder location=new StringBuilder(redirURL);
  String c=(location.indexOf("?") == -1) ? "?code=" : "&code=";
  location.append(c).append(code);
  appendState(location);
  addCacheDirective(getResponse(),CacheDirective.noStore());
  getLogger().fine("Redirecting to -> " + location.toString());
  return location.toString();
}

{
  if (entity instanceof Representation) {
    final Representation repr=(Representation)entity;
    repr.setCharacterSet(getSupportedCharSet(repr.getCharacterSet()));
    if (jaxRsResponseMediaType != null) {
      repr.setMediaType(Converter.getMediaTypeWithoutParams(jaxRsResponseMediaType));
    }
    return repr;
  }
  Type genericReturnType;
  Class<? extends Object> entityClass;
  Annotation[] methodAnnotations;
  if (resourceMethod != null) {
    methodAnnotations=resourceMethod.getAnnotations();
  }
 else {
    methodAnnotations=EMPTY_ANNOTATION_ARRAY;
  }
  if (entity instanceof GenericEntity) {
    final GenericEntity<?> genericEntity=(GenericEntity)entity;
    genericReturnType=genericEntity.getType();
    entityClass=genericEntity.getRawType();
    entity=genericEntity.getEntity();
  }
 else {
    entityClass=(entity != null) ? entity.getClass() : null;
    if (resourceMethod != null) {
      genericReturnType=resourceMethod.getGenericReturnType();
    }
 else {
      genericReturnType=null;
    }
    if ((genericReturnType instanceof Class) && ((Class)genericReturnType).isAssignableFrom(javax.ws.rs.core.Response.class)) {
      genericReturnType=entityClass;
    }
  }
  MessageBodyWriterSubSet mbws;
  if (entity != null) {
    mbws=this.entityProviders.writerSubSet(entityClass,genericReturnType,methodAnnotations);
    if (mbws.isEmpty()) {
      throw this.excHandler.noMessageBodyWriter(entityClass,genericReturnType,methodAnnotations);
    }
  }
 else {
    mbws=MessageBodyWriterSubSet.empty();
  }
  MediaType respMediaType;
  if (jaxRsResponseMediaType != null) {
    respMediaType=jaxRsResponseMediaType;
  }
 else   if (resourceMethod != null) {
    respMediaType=determineMediaType(resourceMethod,mbws);
  }
 else {
    respMediaType=MediaType.TEXT_PLAIN;
  }
  final Response response=this.tlContext.get().getResponse();
  final MultivaluedMap<String,Object> httpResponseHeaders=new WrappedRequestForHttpHeaders(response,jaxRsRespHeaders,getLogger());
  Representation repr;
  if (entity == null) {
    repr=Representation.createEmpty();
    repr.setMediaType(respMediaType);
  }
 else {
    MessageBodyWriter<?> mbw;
    mbw=mbws.getBestWriter(respMediaType,accMediaTypes);
    if (mbw == null) {
      throw this.excHandler.noMessageBodyWriter(entityClass,genericReturnType,methodAnnotations);
    }
    repr=new JaxRsOutputRepresentation(entity,genericReturnType,respMediaType,methodAnnotations,mbw,httpResponseHeaders);
  }
  repr.setCharacterSet(getSupportedCharSet(httpResponseHeaders));
  return repr;
}

{
  final CallContext callContext=this.tlContext.get();
  Collection<MediaType> p=resourceMethod.getProducedMimes();
  if (p.isEmpty()) {
    p=mbws.getAllProducibleMediaTypes();
    if (p.isEmpty()) {
      return MediaType.APPLICATION_OCTET_STREAM;
    }
  }
  SortedMetadata<MediaType> a=callContext.getAccMediaTypes();
  if (a.isEmpty()) {
    a=SortedMetadata.getMediaTypeAll();
  }
  final List<MediaType> pSorted=sortByConcreteness(p);
  final List<MediaType> m=new ArrayList<MediaType>();
  for (  final MediaType prod : pSorted) {
    for (    final MediaType acc : a) {
      if (prod.isCompatible(acc)) {
        m.add(MediaType.getMostSpecific(prod,acc));
      }
    }
  }
  if (m.isEmpty()) {
    this.excHandler.notAcceptableWhileDetermineMediaType();
  }
  for (  final MediaType mediaType : m) {
    if (mediaType.isConcrete()) {
      return mediaType;
    }
  }
  if (m.contains(MediaType.ALL) || m.contains(MediaType.APPLICATION_ALL)) {
    return MediaType.APPLICATION_OCTET_STREAM;
  }
  throw this.excHandler.notAcceptableWhileDetermineMediaType();
}

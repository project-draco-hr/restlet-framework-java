{
  if (variants == null) {
    return null;
  }
 else {
    Parameter currentParam=null;
    Language currentLanguage=null;
    Language variantLanguage=null;
    MediaType currentMediaType=null;
    MediaType variantMediaType=null;
    boolean compatiblePref=false;
    boolean compatibleLanguage=false;
    boolean compatibleMediaType=false;
    Representation currentVariant=null;
    Representation bestVariant=null;
    LanguagePref currentLanguagePref=null;
    LanguagePref bestLanguagePref=null;
    MediaTypePref currentMediaTypePref=null;
    MediaTypePref bestMediaTypePref=null;
    float bestQuality=0;
    float currentScore=0;
    float bestLanguageScore=0;
    float bestMediaTypeScore=0;
    for (Iterator iter1=variants.iterator(); iter1.hasNext(); ) {
      currentVariant=(Representation)iter1.next();
      variantLanguage=currentVariant.getLanguage();
      variantMediaType=currentVariant.getMediaType();
      List<LanguagePref> languagePrefs=client.getLanguagePrefs();
      if (languagePrefs.size() == 0)       languagePrefs.add(new LanguagePref(Languages.ALL));
      for (Iterator<LanguagePref> iter2=languagePrefs.iterator(); (variantLanguage != null) && iter2.hasNext(); ) {
        currentLanguagePref=iter2.next();
        currentLanguage=currentLanguagePref.getLanguage();
        compatiblePref=true;
        currentScore=0;
        if (variantLanguage.getMainTag().equals(currentLanguage.getMainTag())) {
          currentScore+=100;
        }
 else         if (!currentLanguage.getMainTag().equals("*")) {
          compatiblePref=false;
        }
 else         if (currentLanguage.getSubTag() != null) {
          compatiblePref=false;
        }
 else {
          currentScore++;
        }
        if (compatiblePref) {
          if ((currentLanguage.getSubTag() == null) || (variantLanguage.getSubTag() == null)) {
            if (variantLanguage.getSubTag() == currentLanguage.getSubTag()) {
              currentScore+=10;
            }
 else {
            }
          }
 else           if (currentLanguage.getSubTag().equals(variantLanguage.getSubTag())) {
            currentScore+=10;
          }
 else {
            compatiblePref=false;
          }
          if (compatiblePref && ((bestLanguagePref == null) || (currentScore > bestLanguageScore))) {
            bestLanguagePref=currentLanguagePref;
            bestLanguageScore=currentScore;
          }
        }
      }
      compatibleLanguage=(variantLanguage == null) || (bestLanguagePref != null) || (variantLanguage.equals(fallbackLanguage));
      List<MediaTypePref> mediaTypePrefs=client.getMediaTypePrefs();
      if (mediaTypePrefs.size() == 0)       mediaTypePrefs.add(new MediaTypePref(MediaTypes.ALL));
      for (Iterator<MediaTypePref> iter2=mediaTypePrefs.iterator(); compatibleLanguage && iter2.hasNext(); ) {
        currentMediaTypePref=iter2.next();
        currentMediaType=currentMediaTypePref.getMediaType();
        compatiblePref=true;
        currentScore=0;
        if (currentMediaType.getMainType().equals(variantMediaType.getMainType())) {
          currentScore+=1000;
        }
 else         if (!currentMediaType.getMainType().equals("*")) {
          compatiblePref=false;
        }
 else         if (!currentMediaType.getSubType().equals("*")) {
          compatiblePref=false;
        }
        if (compatiblePref) {
          if (variantMediaType.getSubType().equals(currentMediaType.getSubType())) {
            currentScore+=100;
          }
 else           if (!currentMediaType.getSubType().equals("*")) {
            compatiblePref=false;
          }
          if (compatiblePref && (variantMediaType.getParameters() != null)) {
            for (Iterator iter3=variantMediaType.getParameters().iterator(); iter3.hasNext(); ) {
              currentParam=(Parameter)iter3.next();
              if (isParameterFound(currentParam,currentMediaType)) {
                currentScore++;
              }
            }
          }
          if (compatiblePref && ((bestMediaTypePref == null) || (currentScore > bestMediaTypeScore))) {
            bestMediaTypePref=currentMediaTypePref;
            bestMediaTypeScore=currentScore;
          }
        }
      }
      compatibleMediaType=(variantMediaType == null) || (bestMediaTypePref != null);
      if (compatibleLanguage && compatibleMediaType) {
        float currentQuality=0;
        if (bestLanguagePref != null) {
          currentQuality+=(bestLanguagePref.getQuality() * 10F);
        }
 else         if ((variantLanguage != null) && variantLanguage.equals(fallbackLanguage)) {
          currentQuality+=0.1F * 10F;
        }
        if (bestMediaTypePref != null) {
          currentQuality+=bestMediaTypePref.getQuality();
        }
        if (bestVariant == null) {
          bestVariant=currentVariant;
          bestQuality=currentQuality;
        }
 else         if (currentQuality > bestQuality) {
          bestVariant=currentVariant;
          bestQuality=currentQuality;
        }
      }
      bestLanguagePref=null;
      bestLanguageScore=0;
      bestMediaTypePref=null;
      bestMediaTypeScore=0;
    }
    return bestVariant;
  }
}

{
  String origin=request.getHeaders().getFirstValue("Origin",true);
  if (origin == null) {
    return;
  }
  if (!allowOrigins.contains("*") && !allowOrigins.contains(origin)) {
    return;
  }
  boolean isPreflightRequest=Method.OPTIONS.equals(request.getMethod());
  if (isPreflightRequest) {
    Method accessControlRequestMethod=request.getAccessControlRequestMethod();
    if (accessControlRequestMethod == null) {
      return;
    }
    Method requestedMethod=request.getAccessControlRequestMethod();
    if (requestedMethod == null) {
      return;
    }
    if (!allowOnlyRequestedMethod && (allowMethods == null || !allowMethods.contains(requestedMethod))) {
      return;
    }
    Set<String> requestedHeaders=request.getAccessControlRequestHeaders();
    if (requestedHeaders == null) {
      requestedHeaders=SetUtils.newHashSet();
    }
    if (!allowOnlyRequestedHeaders && (allowHeaders == null || !isAllHeadersAllowed(allowHeaders,requestedHeaders))) {
      return;
    }
    response.setAccessControlAllowMethods(SetUtils.newHashSet(requestedMethod));
    response.setAccessControlAllowHeaders(requestedHeaders);
  }
 else {
    if (exposeHeaders != null && !exposeHeaders.isEmpty()) {
      response.setAccessControlExposeHeaders(exposeHeaders);
    }
  }
  if (allowCredentials) {
    response.setAccessControlAllowCredential(true);
  }
  response.setAccessControlAllowOrigin(origin);
}

def proxy_open(self, req, proxy, type):
    orig_type = req.get_type()
    (proxy_type, user, password, hostport) = _parse_proxy(proxy)
    if (proxy_type is None):
        proxy_type = orig_type
    if (user and password):
        user_pass = ('%s:%s' % (unquote(user), unquote(password)))
        creds = base64.b64encode(user_pass).strip()
        req.add_header('Proxy-authorization', ('Basic ' + creds))
    hostport = unquote(hostport)
    req.set_proxy(hostport, proxy_type)
    if (orig_type == proxy_type):
        return None
    else:
        return self.parent.open(req)

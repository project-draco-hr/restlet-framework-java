{
  this.lastActivity=System.currentTimeMillis();
  try {
    if ((key == null) || key.isReadable()) {
      getInboundWay().onSelected();
    }
 else     if (key.isWritable()) {
      getOutboundWay().onSelected();
    }
 else     if (key.isConnectable()) {
      try {
        if (getSocketChannel().finishConnect()) {
          open();
        }
 else {
          getLogger().info("Unable to establish a connection to " + getSocket().getInetAddress());
          setState(ConnectionState.CLOSING);
        }
      }
 catch (      IOException e) {
        getLogger().warning("Unable to establish a connection to " + getSocket().getInetAddress());
        setState(ConnectionState.CLOSING);
      }
    }
  }
 catch (  Throwable t) {
    getLogger().log(Level.WARNING,"Unexpected error detected. Closing the connection.",t);
    onError();
  }
}

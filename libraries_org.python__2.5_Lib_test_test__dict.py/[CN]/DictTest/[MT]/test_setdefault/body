def test_setdefault(self):
    d = {}
    self.assert_((d.setdefault('key0') is None))
    d.setdefault('key0', [])
    self.assert_((d.setdefault('key0') is None))
    d.setdefault('key', []).append(3)
    self.assertEqual(d['key'][0], 3)
    d.setdefault('key', []).append(4)
    self.assertEqual(len(d['key']), 2)
    self.assertRaises(TypeError, d.setdefault)


    class Exc(Exception):
        pass


    class BadHash(object):
        fail = False

        def __hash__(self):
            if self.fail:
                raise Exc()
            else:
                return 42
    x = BadHash()
    d[x] = 42
    x.fail = True
    self.assertRaises(Exc, d.setdefault, x, [])

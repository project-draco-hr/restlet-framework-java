{
  int next;
  if (builderState == BufferState.IDLE) {
    builderState=BufferState.FILLING;
  }
  while ((builderState != BufferState.DRAINING) && byteBuffer.hasRemaining()) {
    next=(int)byteBuffer.get();
switch (builderState) {
case FILLING:
      if (HeaderUtils.isCarriageReturn(next)) {
        builderState=BufferState.FILLED;
      }
 else {
        lineBuilder.append((char)next);
      }
    break;
case FILLED:
  if (HeaderUtils.isLineFeed(next)) {
    builderState=BufferState.DRAINING;
  }
 else {
    throw new IOException("Missing line feed character at the end of the line. Found character \"" + (char)next + "\" ("+ next+ ") instead");
  }
break;
}
}
return builderState;
}

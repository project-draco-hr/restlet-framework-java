def test_visible(self):
    msg = mailbox.BabylMessage(_sample_message)
    visible = msg.get_visible()
    self.assert_((visible.keys() == []))
    self.assert_((visible.get_payload() is None))
    visible['User-Agent'] = 'FooBar 1.0'
    visible['X-Whatever'] = 'Blah'
    self.assert_((msg.get_visible().keys() == []))
    msg.set_visible(visible)
    visible = msg.get_visible()
    self.assert_((visible.keys() == ['User-Agent', 'X-Whatever']))
    self.assert_((visible['User-Agent'] == 'FooBar 1.0'))
    self.assert_((visible['X-Whatever'] == 'Blah'))
    self.assert_((visible.get_payload() is None))
    msg.update_visible()
    self.assert_((visible.keys() == ['User-Agent', 'X-Whatever']))
    self.assert_((visible.get_payload() is None))
    visible = msg.get_visible()
    self.assert_((visible.keys() == ['User-Agent', 'Date', 'From', 'To', 'Subject']))
    for header in ('User-Agent', 'Date', 'From', 'To', 'Subject'):
        self.assert_((visible[header] == msg[header]))

def test_popitem(self, iterations=10):
    keys = []
    for i in xrange(10):
        keys.append(self._box.add((self._template % i)))
    seen = []
    for i in xrange(10):
        (key, msg) = self._box.popitem()
        self.assert_((key in keys))
        self.assert_((key not in seen))
        seen.append(key)
        self.assert_((int(msg.get_payload()) == keys.index(key)))
    self.assert_((len(self._box) == 0))
    for key in keys:
        self.assertRaises(KeyError, (lambda : self._box[key]))

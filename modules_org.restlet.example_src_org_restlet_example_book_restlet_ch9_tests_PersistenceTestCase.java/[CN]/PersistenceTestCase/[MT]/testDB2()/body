{
  Contact contactProto=new Contact();
  Predicate<Mail> mailByContactNamePredicate=new Predicate<Mail>(){
    @Override public boolean match(    Mail mail){
      boolean found=false;
      for (      Contact contact : mail.getPrimaryRecipients()) {
        if ("contact-5".equals(contact.getName())) {
          found=true;
          break;
        }
      }
      return found;
    }
  }
;
  Predicate<MailBox> mailboxByContactNamePredicate=new Predicate<MailBox>(){
    @Override public boolean match(    MailBox mailBox){
      boolean found=false;
      for (      Contact contact : mailBox.getContacts()) {
        if ("contact-5".equals(contact.getName())) {
          found=true;
          break;
        }
      }
      return found;
    }
  }
;
  ObjectSet<Contact> contactList;
  ObjectSet<Mail> mailList;
  ObjectSet<MailBox> mailBoxList;
  contactProto.setName("contact-4");
  contactList=objectContainer.queryByExample(contactProto);
  assertEquals(contactList.size(),1);
  mailList=objectContainer.query(mailByContactNamePredicate);
  assertEquals(mailList.size(),1);
  Contact contact=contactList.get(0);
  contact.setName("contact-5");
  objectContainer.store(contact);
  objectContainer.commit();
  mailList=objectContainer.query(mailByContactNamePredicate);
  assertEquals(mailList.size(),2);
  mailBoxList=objectContainer.query(mailboxByContactNamePredicate);
  assertEquals(mailBoxList.size(),1);
  contactProto.setName("contact-5");
  contactList=objectContainer.queryByExample(contactProto);
  for (  Contact contact2 : contactList) {
    for (    MailBox mailBox : mailBoxList) {
      boolean found=false;
      for (int i=0; i < mailBox.getContacts().size() && !found; i++) {
        Contact contact3=mailBox.getContacts().get(i);
        if (contact2.getId().equals(contact3.getId())) {
          mailBox.getContacts().remove(i);
          found=true;
        }
      }
      objectContainer.store(mailBox);
    }
    for (    Mail mail : mailList) {
      List<Contact> list=new ArrayList<Contact>();
      for (int i=0; i < mail.getPrimaryRecipients().size(); i++) {
        Contact contact3=mail.getPrimaryRecipients().get(i);
        if (!contact2.getId().equals(contact3.getId())) {
          list.add(contact3);
        }
      }
      mail.setPrimaryRecipients(list);
      objectContainer.store(mail);
    }
    objectContainer.delete(contact2);
  }
  objectContainer.commit();
  contactList=objectContainer.queryByExample(contactProto);
  assertTrue(contactList.isEmpty());
  mailBoxList=objectContainer.query(mailboxByContactNamePredicate);
  assertTrue(mailBoxList.isEmpty());
  mailList=objectContainer.query(mailByContactNamePredicate);
  assertTrue(mailList.isEmpty());
}

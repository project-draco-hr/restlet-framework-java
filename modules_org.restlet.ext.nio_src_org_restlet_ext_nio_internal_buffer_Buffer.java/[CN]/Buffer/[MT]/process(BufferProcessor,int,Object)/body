{
  int result=0;
synchronized (getLock()) {
    int totalFilled=0;
    int drained=0;
    int filled=0;
    boolean lastDrainFailed=false;
    boolean lastFillFailed=false;
    boolean fillEnded=false;
    boolean tryAgain=true;
    if (Context.getCurrentLogger().isLoggable(Level.FINEST)) {
      Context.getCurrentLogger().log(Level.FINEST,"Beginning process of buffer " + this);
    }
    result+=processor.preProcess(maxDrained,args);
    if (Context.getCurrentLogger().isLoggable(Level.FINEST)) {
      Context.getCurrentLogger().log(Level.FINEST,result + " bytes drained from buffer at pre-processing, " + remaining()+ " remaining bytes");
    }
    while (tryAgain && processor.canLoop(this,args)) {
      if (isDraining()) {
        if (Context.getCurrentLogger().isLoggable(Level.FINEST)) {
          Context.getCurrentLogger().log(Level.FINEST,"Draining buffer " + this);
        }
        drained=0;
        if (hasRemaining()) {
          if (maxDrained <= 0) {
            drained=processor.onDrain(this,0,args);
          }
 else           if (maxDrained > result) {
            drained=processor.onDrain(this,maxDrained - result,args);
          }
        }
        if (drained > 0) {
          result+=drained;
          lastDrainFailed=false;
          lastFillFailed=false;
          if (Context.getCurrentLogger().isLoggable(Level.FINEST)) {
            Context.getCurrentLogger().log(Level.FINEST,drained + " bytes drained from buffer, " + remaining()+ " remaining bytes");
          }
        }
 else {
          if (!lastFillFailed) {
            if (couldFill()) {
              beforeFill();
            }
 else             if (canCompact()) {
              compact();
            }
 else {
              tryAgain=false;
            }
          }
 else {
            tryAgain=false;
          }
          lastDrainFailed=true;
        }
      }
 else       if (isFilling()) {
        if (Context.getCurrentLogger().isLoggable(Level.FINEST)) {
          Context.getCurrentLogger().log(Level.FINEST,"Filling buffer " + this);
        }
        filled=0;
        if (hasRemaining() && processor.couldFill(this,args)) {
          filled=processor.onFill(this,args);
        }
        if (filled > 0) {
          totalFilled+=filled;
          lastDrainFailed=false;
          lastFillFailed=false;
          if (Context.getCurrentLogger().isLoggable(Level.FINEST)) {
            Context.getCurrentLogger().log(Level.FINEST,filled + " bytes filled into buffer");
          }
        }
 else {
          if (!lastDrainFailed && couldDrain()) {
            beforeDrain();
          }
 else {
            tryAgain=false;
          }
          if (filled == -1) {
            fillEnded=true;
            processor.onFillEof();
          }
          lastFillFailed=true;
        }
      }
 else {
        tryAgain=false;
      }
    }
    if ((result == 0) && (!processor.couldFill(this,args) || fillEnded)) {
      result=-1;
    }
    if (Context.getCurrentLogger().isLoggable(Level.FINEST)) {
      Context.getCurrentLogger().log(Level.FINEST,"Ending process of buffer " + this + ". Result: "+ result+ ", try again: "+ tryAgain+ ", can loop: "+ processor.canLoop(this,args)+ ", total filled: "+ totalFilled);
    }
    processor.postProcess(result);
  }
  return result;
}

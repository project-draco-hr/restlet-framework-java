{
  boolean isStreaming=isStreaming();
  Writer writer=this.resource.getWriter();
  ScriptSource.ScriptDescriptor<CompositeScript> scriptDescriptor=this.resource.getScriptSource().getScriptDescriptor(name);
  CompositeScript script=scriptDescriptor.getScript();
  if (script == null) {
    String text=scriptDescriptor.getText();
    if (scriptEngineName != null) {
      text=CompositeScript.DEFAULT_DELIMITER1_START + scriptEngineName + " "+ text+ CompositeScript.DEFAULT_DELIMITER1_END;
    }
    script=new CompositeScript(text,this.resource.getScriptEngineManager(),this.resource.getDefaultScriptEngineName(),this.resource.getScriptSource(),this.resource.isAllowCompilation());
    CompositeScript existing=scriptDescriptor.setScriptIfAbsent(script);
    if (existing != null) {
      script=existing;
    }
  }
  String trivial=script.getTrivial();
  if (trivial != null) {
    if (writer != null) {
      writer.write(trivial);
    }
    return new StringRepresentation(trivial,getMediaType(),getLanguage(),getCharacterSet());
  }
  int startPosition=0;
  if (!isStreaming) {
    if (writer == null) {
      StringWriter stringWriter=new StringWriter();
      this.buffer=stringWriter.getBuffer();
      writer=new BufferedWriter(stringWriter);
      this.resource.setWriter(writer);
    }
 else {
      writer.flush();
      startPosition=this.buffer.length();
    }
  }
  try {
    if (script.run(!isStreaming,writer,this.resource.getErrorWriter(),false,this.compositeScriptContext,this,this.resource.getScriptContextController())) {
      if (this.startStreaming) {
        this.startStreaming=false;
        return new ScriptedTextStreamingRepresentation(this.resource,this,this.compositeScriptContext,this.resource.getScriptContextController(),script,this.flushLines);
      }
      if (isStreaming) {
        return null;
      }
 else {
        writer.flush();
        RepresentableString string=new RepresentableString(this.buffer.substring(startPosition),getMediaType(),getLanguage(),getCharacterSet());
        this.cache.put(name,string);
        if (startPosition == 0) {
          return string.represent();
        }
 else {
          return new StringRepresentation(this.buffer.toString(),getMediaType(),getLanguage(),getCharacterSet());
        }
      }
    }
 else {
      RepresentableString string=this.cache.get(name);
      if (string != null) {
        if (writer != null) {
          writer.write(string.getString());
        }
        return string.represent();
      }
 else {
        return null;
      }
    }
  }
 catch (  ScriptException x) {
    if (this.startStreaming) {
      this.startStreaming=false;
      return new ScriptedTextStreamingRepresentation(this.resource,this,this.compositeScriptContext,this.resource.getScriptContextController(),script,this.flushLines);
    }
 else {
      throw x;
    }
  }
}

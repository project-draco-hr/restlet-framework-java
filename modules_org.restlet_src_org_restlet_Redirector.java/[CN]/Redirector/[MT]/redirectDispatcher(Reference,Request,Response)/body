{
  Reference baseRef=request.getResourceRef().getBaseRef();
  request.setResourceRef(targetRef);
  request.getAttributes().remove("org.restlet.http.headers");
  getContext().getClientDispatcher().handle(request,response);
  response.setEntity(rewrite(response.getEntity()));
  response.getAttributes().remove("org.restlet.http.headers");
  if (response.getLocationRef() != null) {
    Template rt=new Template(getLogger(),this.targetTemplate);
    int matched=rt.parse(response.getLocationRef().toString(),request);
    if (matched > 0) {
      String remainingPart=(String)request.getAttributes().get("rr");
      if (remainingPart != null) {
        response.setLocationRef(baseRef.toString() + remainingPart);
      }
    }
  }
}

{
  Series<CookieSetting> result=null;
  Form form=new Form();
  form.add(OAuthServerResource.RESPONSE_TYPE,OAuthServerResource.ResponseType.code_and_token.name());
  form.add(OAuthServerResource.CLIENT_ID,params.getClientId());
  form.add(OAuthServerResource.REDIR_URI,callbackUri);
  if (params.getScope() != null && params.getScope().length() > 0) {
    form.add(OAuthServerResource.SCOPE,params.getScope());
  }
  form.add("email",fbUser);
  form.add("pass",fbPass);
  String q=form.getQueryString();
  Reference redirRef=new Reference(params.getBaseRef(),params.getAuthorizePath(),q,null);
  ClientResource authResource=new CookieCopyClientResource(redirRef.toUri());
  authResource.setFollowingRedirects(false);
  Representation r=authResource.get();
  int maxRedirCnt=10;
  int cnt=0;
  while (authResource.getStatus().isRedirection()) {
    String fragment=authResource.getLocationRef().getFragment();
    if (fragment != null && fragment.length() > 0) {
      Form f=new Form(fragment);
      String accessToken=f.getFirstValue(OAuthServerResource.ACCESS_TOKEN);
      String refreshToken=f.getFirstValue(OAuthServerResource.REFRESH_TOKEN);
      long expiresIn=0;
      String exp=f.getFirstValue(OAuthServerResource.EXPIRES_IN);
      if (exp != null && exp.length() > 0) {
        expiresIn=Long.parseLong(exp);
      }
      if (accessToken != null && accessToken.length() > 0) {
        Context.getCurrentLogger().info("Successful UserAgent flow : AccessToken = " + accessToken + " RefreshToken = "+ refreshToken+ " ExpiresIn = "+ expiresIn);
        break;
      }
    }
    if (++cnt >= maxRedirCnt)     break;
    Context.getCurrentLogger().info("Redir to = " + authResource.getLocationRef());
    authResource.setReference(authResource.getLocationRef());
    authResource.get();
  }
  if (authResource.getStatus().isSuccess()) {
    result=authResource.getCookieSettings();
  }
  r.release();
  authResource.release();
  return result;
}

{
  if (graceful) {
    if (getLogger().isLoggable(Level.FINER)) {
      getLogger().log(Level.FINER,"Closing connection to " + getSocketAddress() + " gracefully");
    }
    if (getRegistration() != null) {
      getRegistration().setCanceling(true);
    }
    setState(ConnectionState.CLOSING);
  }
 else {
    if (getLogger().isLoggable(Level.FINER)) {
      getLogger().log(Level.FINER,"Closing connection to " + getSocketAddress() + " immediately");
    }
    try {
      if ((getSocket() != null) && !getSocket().isClosed()) {
        if (!(getSocket() instanceof SSLSocket)) {
          getSocket().shutdownInput();
          getSocket().shutdownOutput();
        }
      }
    }
 catch (    IOException ex) {
      getLogger().log(Level.FINE,"Unable to properly shutdown socket",ex);
    }
 finally {
      setState(ConnectionState.CLOSED);
    }
    try {
      if ((getSocket() != null) && !getSocket().isClosed()) {
        getSocket().close();
      }
    }
 catch (    IOException ex) {
      getLogger().log(Level.FINE,"Unable to properly close socket",ex);
    }
 finally {
      setState(ConnectionState.CLOSED);
    }
  }
}

{
  Variant selectedVariant=null;
  if (isNegotiateContent()) {
    List<Variant> variants=target.getVariants();
    if ((variants == null) || (variants.isEmpty())) {
      response.setStatus(Status.CLIENT_ERROR_NOT_FOUND);
    }
 else {
      Variant preferredVariant=response.getRequest().getClientInfo().getPreferredVariant(variants);
      response.getDimensions().add(Dimension.CHARACTER_SET);
      response.getDimensions().add(Dimension.ENCODING);
      response.getDimensions().add(Dimension.LANGUAGE);
      response.getDimensions().add(Dimension.MEDIA_TYPE);
      if (preferredVariant == null) {
        response.setStatus(Status.CLIENT_ERROR_NOT_ACCEPTABLE);
        ReferenceList refs=new ReferenceList(variants.size());
        for (        Variant variant : variants) {
          if (variant.getIdentifier() != null) {
            refs.add(variant.getIdentifier());
          }
        }
        response.setEntity(refs.getTextRepresentation());
      }
 else {
        response.setEntity(target.getRepresentation(preferredVariant));
        selectedVariant=preferredVariant;
      }
    }
    selectedVariant=response.getEntity();
  }
 else {
    List<Variant> variants=target.getVariants();
    if (variants.isEmpty()) {
      response.setStatus(Status.CLIENT_ERROR_NOT_FOUND);
    }
 else     if (variants.size() == 1) {
      response.setEntity(variants.get(0));
      selectedVariant=response.getEntity();
    }
 else {
      ReferenceList variantRefs=new ReferenceList();
      for (      Variant variant : variants) {
        if (variant.getIdentifier() != null) {
          variantRefs.add(variant.getIdentifier());
        }
 else {
          getLogger().warning("A resource with multiple variants should provide and identifier for each variants when content negotiation is turned off");
        }
      }
      if (variantRefs.size() > 0) {
        response.setStatus(Status.REDIRECTION_MULTIPLE_CHOICES);
        response.setEntity(variantRefs.getTextRepresentation());
      }
 else {
        response.setStatus(Status.CLIENT_ERROR_NOT_FOUND);
      }
    }
  }
  if (selectedVariant != null && hasPreconditions(request.getConditions())) {
    Status status=getConditionalStatus(request.getConditions(),request.getMethod(),selectedVariant);
    if (status != null) {
      response.setStatus(status);
      response.setEntity(null);
    }
  }
}
